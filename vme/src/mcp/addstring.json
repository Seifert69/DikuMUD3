{
    "keyword": "addstring",
    "opcode": "DILSI_ADL",
    "yacc_rule": "| DILSI_ADL '(' coreexp ',' coreexp ')' ihold\n{\n    if (($3.typ != DilVarType_e::DILV_SLP) || ($3.dsl != DSL_LFT))\n    {\n        dilfatal(\"Arg 1 of 'addlist' not a stringlist variable\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 2 of 'addlist' not a string\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $7 + 1;\n        wtmp = &tmpl.core[$7];\n        bwrite_ubit8(&wtmp, DILI_ADL);\n    }\n}",
    "dilfe_name": "dilfi_adl",
    "c_implementation": "void dilfi_adl(dilprg *p)\n{\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    p->waitcmd--;\n\n    switch (v1->type)\n    {\n        case DILV_SLPR:\n            if (dil_type_check(\"addstring\", p, 1, v2, FAIL_NULL, 1, DILV_SP))\n            {\n                if (v2->val.ptr)\n                {\n                    if (isblank(*(char *)v2->val.ptr))\n                        slog(LOG_ALL, 0, \"DIL %s addstring [%s] has whitespace\", p->fp->tmpl->prgname, (char *)v2->val.ptr);\n\n                    ((cNamelist *)v1->ref)->AppendNameTrim((char *)v2->val.ptr);\n                }\n            }\n            break;\n\n        case DILV_FAIL:\n            break;\n        default:\n            /* ERROR not right lvalue */\n            dil_typeerr(p, \"lvalue addstring\");\n            break;\n    }\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin li2();\nvar\n  pc     : unitptr;\n  item   : unitptr;\n  exdp   : extraptr;\n\n  code\n  {\n    heartbeat := PULSE_SEC*5;\n    on_activation((self.position <= POSITION_SLEEPING) or\n\t       (self.position == POSITION_FIGHTING), skip);\n\n    :start:\n    wait(SFB_CMD, command(\"give\") and\n\t(activator.type == UNIT_ST_PC));\n\n    :give:\n    if (not(LIB_ONGOING in activator.quests))\n\tgoto start;\n\n    pc := activator;\n    item := self.inside;\n    secure(pc, labsecure);\n    secure(item, labsecure);\n\n    wait(SFB_CMD | SFB_TICK, TRUE);\n    if(not(item #= self.inside))\n    {\n      unsecure(item);\n      exdp := LIB_ONGOING in pc.quests;\n\n     if(\"quill\" in self.inside.name)\n     {\n\t\taddstring(exdp.names, \"quill\");\n\t\texec(\"say This will help me write.\", self);\n\t\tdestroy(self.inside);\n     }\n     else if(\"book of knowledge\" in self.inside.name)\n     {\n\t\taddstring(exdp.names, \"book of knowledge\");\n\t\texec(\"say Ahh, the Book of Knowledge.\", self);\n\t\tdestroy(self.inside);\n     }\n     else if(\"vellum scrap\" in self.inside.name)\n     {\n\t\taddstring(exdp.names, \"vellum scrap\");\n\t\texec(\"say The tales I search for...\", self);\n\t\tdestroy(self.inside);\n     }\n     else\n     {\n\t\texec(\"say This is not what I am looking \" +\n\t\t     \"for \" +pc.name + \".\", self);\n\t\tpause;\n\t\texec(\"say Please have it back.\", self);\n\t\tlink(self.inside, pc);\n     }\n    }\n    unsecure(pc);\n\n    if((command(\"give\")) and\n       (activator.type == UNIT_ST_PC))\n    {\n      goto give;\n    }\n      else\n\tgoto start;\n\n    :labsecure:\n    exec(\"sigh\", self);\n    goto start;\n\n} dilend"
}