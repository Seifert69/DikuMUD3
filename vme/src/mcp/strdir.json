{
    "keyword": "strdir",
    "opcode": "DILSE_SDIR",
    "yacc_rule": "| DILSE_SDIR '(' dilexp ')'\n{\n    INITEXP($$);\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'strdir' not string\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_SLP;\n        add_code(&($$), &($3));\n        add_ubit8(&($$), DILE_SDIR);\n    }\n    FREEEXP($3);\n}",
    "dilfe_name": "dilfe_sdir",
    "c_implementation": "void dilfe_sdir(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v1 = p->stack.pop();\n    cNamelist *words = new cNamelist;\n\n    v->type = DILV_SLP;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_SP:\n            if (v1->val.ptr)\n            {\n                v->atyp = DILA_EXP;\n                v->type = DILV_SLP;\n\n                std::filesystem::path uPath{p->frame[0].tmpl->zone->getDILFilePath().value_or(g_cServerConfig.getDILFileDir())};\n                uPath += \"/strings\";\n\n                std::string sPath{(char *)v1->val.ptr};\n                if (sPath.empty())\n                {\n                    sPath = \".*\";\n                }\n\n                boost::filesystem::path full_path(uPath);\n                boost::filesystem::directory_iterator end_iter;\n\n                boost::regex expression;\n\n                try\n                {\n                    expression.assign(sPath);\n                }\n                catch (std::exception &e)\n                {\n                    v->type = DILV_ERR;\n                    break;\n                }\n\n                try\n                {\n                    if ((boost::filesystem::exists(full_path)) && (boost::filesystem::is_directory(full_path)))\n                    {\n                        for (boost::filesystem::directory_iterator dir_itr(full_path); dir_itr != end_iter; ++dir_itr)\n                        {\n                            boost::cmatch what;\n\n                            if (regex_match(dir_itr->path().filename().c_str(), what, expression))\n                            {\n                                words->AppendName(dir_itr->path().filename().c_str());\n                            }\n                        }\n                    }\n                }\n                catch (std::exception &ex)\n                {\n                    v->type = DILV_ERR;\n                    break;\n                }\n\n                v->val.ptr = words;\n            }\n            else\n            {\n                v->type = DILV_FAIL;\n            }\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n\n    p->stack.push(v);\n    delete v1;\n}",
    "dil_example": "dilbegin boot_comp ();\nexternal \n\tinteger load_file(cname:string);\nvar\n\trm:unitptr;\n\tflist:stringlist;\n\ti:integer;\n\tln:integer;\n\tnl,cl:stringlist;\ncode\n{\n\theartbeat:=5*60*PULSE_SEC;\n\trm:=restore(\"comp_obj\",null);\n\tif (rm==null)\n\t{\n\t\trm:=load(\"board_obj@competition\");\n\t\tif (rm==null)\n\t\t{\n\t\t\tlog (\"Competition board_obj error.<br>\");\n\t\t\tgoto xp_load;\n\t\t}\n\t\tlink(rm,self);\n\t\tflist:=strdir(\".*.comp\");\n\t\ti:=0;         \n\t\tln:=length(flist);\n\t\twhile (i<ln)\n\t\t{\n\t\t\tif (flist.[i]==\"\")\n\t\t\t{\n\t\t\t\ti:=i+1;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tnl:=split(flist.[i],\".\");\n\t\t\tif (length(nl)<2)\n\t\t\t{\n\t\t\t\ti:=i+1;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tload_file(nl.[0]);\n\t\t\ti:=i+1;\n\t\t}\n\t\tpause;\n\t\taddextra (self.extra,{\"competition loaded\"},\"Extra to fix quick reboot log on problem\");\n\t}\n\telse \n\t\tlink(rm,self);\n\n:xp_load:\n\n\trm:=restore(\"xp_obj\",null);\n\tif (rm==null)\n\t{\n\t\trm:=load(\"xp_obj@competition\");\n\t\tif (rm==null)\n\t\t{\n\t\t\tlog (\"XP board_obj error.<br>\");\n\t\t\tgoto dead_load;\n\t\t}\n\t}\n\tlink (rm,self);\n\t\n:dead_load:\n\t\n\trm:=restore(\"dead_obj\",null);\n\tif (rm==null)\n\t{\n\t\trm:=load(\"dead_obj@competition\");\n\t\tif (rm==null)\n\t\t{\n\t\t\tlog (\"Death board_obj error.<br>\");\n\t\t\tquit;\n\t\t}\n\t}\n\tlink (rm,self);\n\tquit;\n} dilend"
}