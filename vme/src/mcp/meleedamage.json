{
    "keyword": "meleedamage",
    "opcode": "DILSE_MELDAM",
    "yacc_rule": "| DILSE_MELDAM '(' dilexp ',' dilexp ',' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n    checkbool(\"argument 1 of MeleeAttack\", $3.boolean);\n\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'MeleeAttack' not a unitptr\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 2 of 'MeleeAttack' not a unitptr\");\n    }\n    else if ($7.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 3 of 'MeleeAttack' not an integer\");\n    }\n    else if ($9.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 4 of 'MeleeAttack' not an integer\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n\n        make_code(&($3));\n        make_code(&($5));\n        make_code(&($7));\n        make_code(&($9));\n\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_code(&($$), &($7));\n        add_code(&($$), &($9));\n        add_ubit8(&($$), DILE_MELDAM);\n    }\n\n    FREEEXP($3);\n    FREEEXP($5);\n    FREEEXP($7);\n    FREEEXP($9);\n}",
    "dilfe_name": "dilfe_meldam",
    "c_implementation": "void dilfe_meldam(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v4 = p->stack.pop();\n    dilval *v3 = p->stack.pop();\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_INT;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_UP:\n            if (!v1->val.ptr || !((unit_data *)v1->val.ptr)->isChar())\n            {\n                v->type = DILV_FAIL;\n            }\n            else\n            {\n                switch (dil_getval(v2))\n                {\n                    case DILV_UP:\n                        if (!v2->val.ptr || !((unit_data *)v2->val.ptr)->isChar())\n                        {\n                            v->type = DILV_FAIL;\n                        }\n                        else\n                        {\n                            switch (dil_getval(v3))\n                            {\n                                case DILV_INT:\n                                    switch (dil_getval(v4))\n                                    {\n                                        case DILV_INT:\n                                            v->val.num = one_hit((unit_data *)v1->val.ptr,\n                                                                 (unit_data *)v2->val.ptr,\n                                                                 v3->val.num,\n                                                                 v4->val.num,\n                                                                 TRUE,\n                                                                 FALSE);\n                                            dil_test_secure(p);\n                                            break;\n                                        case DILV_FAIL:\n                                        case DILV_NULL:\n                                            v->type = DILV_FAIL;\n                                            break;\n                                        default:\n                                            v->type = DILV_ERR;\n                                            break;\n                                    }\n\n                                    break;\n                                case DILV_FAIL:\n                                case DILV_NULL:\n                                    v->type = DILV_FAIL;\n                                    break;\n                                default:\n                                    v->type = DILV_ERR;\n                                    break;\n                            }\n                        }\n\n                        break;\n                    case DILV_FAIL:\n                    case DILV_NULL:\n                        v->type = DILV_FAIL;\n                        break;\n                    default:\n                        v->type = DILV_ERR;\n                        break;\n                }\n            }\n\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n    }\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n    delete v3;\n    delete v4;\n}",
    "dil_example": "dilbegin throw (arg : string); /* The throw skill */\n\nexternal\n   integer skillroll@skills(aa : integer, ad : integer, sa : integer,\n                             sd : integer);\n\nvar\nwp_info:intlist;\nwielded:unitptr;\n   held         : unitptr;  /* And what about that other handy... */\n   thing        : unitptr;  /* Well I guess this is our missile. */\n   targ         : unitptr;  /* Hewo wabbit. */\n\n   cost_of      : integer;  /* Endurance cost. */\n   bonus        : integer;  /* For meleedamage. */\n   sharpness    : integer;  /* Approximate sharpness of non-weapons. */\n   miss         : integer;\n   mdam         : integer;  /* Damage the missile takes from the fight */\n   hm           : integer;  /* For skillroll */\n   dead_jim     : integer;  /* did we kill it? huh huh? */\n\n   tstr         : string;   /* Temporary string for processing argument. */\n   tstr2        : string;   /* For corpses */\n   thing_name   : string;   /* In case we ever forget what we're throing. */\nskilla   : integer;\nskillb   : integer;\nskillc   : integer;\nskilld   : integer;\n\ncode\n{\n   heartbeat := 2;\n   miss := 0; /* We hit until we're told differently. */\n   bonus := -20;\n\n   if (self.position < POSITION_STANDING)\n   {\n      act(\"You need to be standing to do that.\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   thing := findunit(self, arg, FIND_UNIT_IN_ME, null);\n\n   if ((thing == null) or not visible(self, thing))\n   {\n      act(\"You can't find that in your inventory or your equipment!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   if (thing.type==UNIT_ST_NPC)\n   {\n   act (\"$1e would not like that.\",\n   A_ALWAYS,self,null,null,TO_CHAR);\n   quit;\n   }\n\nif (thing.type!=UNIT_ST_OBJ)\n   {\n      act(\"You can't find that in your inventory or your equipment!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   thing_name := thing.name;\n\n   if (thing.objecttype != ITEM_WEAPON)\n   {\n      act(\"Why bother throwing that?! Throw a weapon instead!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n\n\n   if ((thing.value[0] == WPN_BOW) or (thing.value[0] == WPN_CROSSBOW) or\n       (thing.value[0] == WPN_SLING))\n       {\n       act (\"You would do better using those correctly than throwing them like a nut case.\",\n       A_ALWAYS,self,null,null,TO_CHAR);\n       quit;\n       }\n\n\nwp_info:=weapon_info(thing.value[0]);\n   wielded := equipment(self, WEAR_WIELD);\n   held    := equipment(self, WEAR_HOLD);\n\nif (wp_info.[0]>1)\n{\nif ((wielded!=self) and\n(held!=self))\n       if ((wielded!=null) or (held!=null))\n       {\n                           act (\"You need both hands free to throw that.\",\n                           A_ALWAYS,self,null,null,TO_CHAR);\n                           quit;\n       }\n}\nelse\n{\nif ((wielded!=self) and\n(held!=self))\nif ((wielded!=null) and (held!=null))\n{\nact (\"You need at least one free hand to throw that.\",\nA_ALWAYS,self,null,null,TO_CHAR);\n}\n}\n\n   tstr := getword(arg);\n\n   if (tstr == \"at\")\n      tstr := arg;\n\n   else if (tstr == \"\")\n   {\n      act(\"What do you want to throw that at?\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   else\n      tstr := tstr + \" \" + arg;\n\n   targ := findunit(self, tstr, FIND_UNIT_SURRO, null);\n\n   if ((targ == null) or (not(visible(self, targ))))\n   {\n      act(\"You don't see that person here!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   if (not(targ.type & (UNIT_ST_PC | UNIT_ST_NPC)))\n   {\n      act(\"Yeah, take your frustration out on that poor inanimate \" +\n          \"object! Hit it, yeah!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   if ((targ.type==UNIT_ST_PC) and (self.type==UNIT_ST_PC))\n   {\n      if (not(isset (self.pcflags, PC_PK_RELAXED)))\n      {\n         act(\"You are not allowed to do that unless you sign \" +\n             \"the book of blood.\",\n             A_ALWAYS, self, null, null, TO_CHAR);\n         quit;\n      }\n\n      if (not(isset (targ.pcflags, PC_PK_RELAXED)))\n      {\n         act(\"You are not allowed to do that unless $2e signs \" +\n             \"the book of blood.\",\n             A_ALWAYS, self, targ, null, TO_CHAR);\n         quit;\n      }\n   }\n\n   wielded := equipment(self, WEAR_WIELD);\n   held    := equipment(self, WEAR_HOLD);\n\n/* This doesn't seem to work, but later in the dil something takes care\nof the case in which you're wielding a weapon.. */\n\n   if ((wielded != null) and (held != null) and ((thing != wielded) and\n                                                 (thing != held)))\n   {\n      act(\"Your hands are full! How do you expect to throw something \" +\n          \"if you don't have a free hand (or aren't throwing what's in \" +\n          \"your hand) ?!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   cost_of := (rnd(20,30) * thing.weight) / 25;\n\n   if (self.endurance < cost_of)\n   {\n      act(\"You simply don't have the energy to throw that!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n      quit;\n   }\n\n   /* DISABLED..Since we can only use meleedamage with Weapons, it's time to\n      distinguish item types so we know which way to go. */\n\n/*\n   if (thing.objecttype == ITEM_WEAPON) goto is_weapon;\n   else goto is_other;\n*/\n\n\n:is_weapon:\n\n/* In a previous version, all targets were assumed having skills,\nwhich caused the mobs to be easier to throw things at.. */\n\nskilla := (self.abilities[ABIL_DEX] + self.abilities[ABIL_STR]/2);\nskillb := (targ.abilities[ABIL_DEX] + targ.abilities[ABIL_STR]/2);\n\nif(self.type == UNIT_ST_PC)\n        skillc := self.skills[SKI_THROW];\nelse\n            skillc := rnd(40,124);\n\t /*   skillc := self.abilities[ABIL_DEX];\n    */\nif(targ.type == UNIT_ST_PC)\n        skilld := targ.skills[SKI_THROW];\nelse\n               skilld := rnd(40,124);\n\t  /*  skilld := targ.abilities[ABIL_DEX];*/\n\nhm := skillroll(skilla,skillb,skillc,skilld);\n\n\n\n/*\n   if (targ.type == UNIT_ST_PC)\n      hm := skillroll@skills((self.abilities[ABIL_DEX] +\n                               self.abilities[ABIL_STR]) /2,\n                               (targ.abilities[ABIL_DEX]*2)/3,\n                               self.skills[SKI_THROW],\n                               targ.skills[SKI_THROW] - 25);\n\n   else\n      hm := skillroll@skills((self.abilities[ABIL_DEX] +\n                               self.abilities[ABIL_STR]) /2,\n                               (targ.abilities[ABIL_DEX]*2)/3,\n                               self.skills[SKI_THROW],\n                               targ.abilities[ABIL_DEX] - 25);\n*/\n   if (hm < 0) goto miss;\n\n   bonus := bonus + (self.weapons[thing.value[0]] /10);\n\n   tstr := \"\";\n   tstr2 := \"\";\n   tstr := targ.name;\n   if (targ.type == UNIT_ST_NPC) tstr2 := targ.title;\n\n   dead_jim := targ.hp;\n\n   if ((thing == held) and (wielded != null))\n   {\n      unequip(wielded);\n      unequip(thing);\n      addequip(thing, WEAR_WIELD);\n      act(\"You throw your \" + thing.name + \" at $3n!\",\n          A_ALWAYS, self, null, targ, TO_CHAR);\n      act(\"$1n throws $1s \" + thing.name + \" at you!\",\n          A_SOMEONE, self, null, targ, TO_VICT);\n      act(\"$1n throw $1s \" + thing.name + \" at $3n!\",\n          A_SOMEONE, self, null, targ, TO_NOTVICT);\n      bonus := meleedamage(self, targ, bonus, 0);\n      unequip(thing);\n      addequip(wielded, WEAR_WIELD);\n   goto dispose_thing;\n   }\n\n   else if (thing == wielded)\n   {\n      act(\"You throw your \" + thing.name + \" at $3n!\",\n          A_ALWAYS, self, null, targ, TO_CHAR);\n      act(\"$1n throws $1s \" + thing.name + \" at you!\",\n          A_SOMEONE, self, null, targ, TO_VICT);\n      act(\"$1n throw $1s \" + thing.name + \" at $3n!\",\n          A_SOMEONE, self, null, targ, TO_NOTVICT);\n      bonus := meleedamage(self, targ, bonus, 0);\n      unequip(thing);\n      goto dispose_thing;\n   }\n\n   else if ((wielded != null) and (thing != wielded))\n   {\n      unequip(wielded);\n      addequip(thing, WEAR_WIELD);\n      act(\"You throw your \" + thing.name + \" at $3n!\",\n          A_ALWAYS, self, null, targ, TO_CHAR);\n      act(\"$1n throws $1s \" + thing.name + \" at you!\",\n          A_SOMEONE, self, null, targ, TO_VICT);\n      act(\"$1n throw $1s \" + thing.name + \" at $3n!\",\n          A_SOMEONE, self, null, targ, TO_NOTVICT);\n      bonus := meleedamage(self, targ, bonus, 0);\n      unequip(thing);\n      addequip(wielded, WEAR_WIELD);\n      goto dispose_thing;\n   }\n\n   else\n   {\n      addequip(thing, WEAR_WIELD);\n      act(\"You throw your \" + thing.name + \" at $3n!\",\n          A_ALWAYS, self, null, targ, TO_CHAR);\n      act(\"$1n throws $1s \" + thing.name + \" at you!\",\n          A_SOMEONE, self, null, targ, TO_VICT);\n      act(\"$1n throw $1s \" + thing.name + \" at $3n!\",\n          A_SOMEONE, self, null, targ, TO_NOTVICT);\n      bonus := meleedamage(self, targ, bonus, 0);\n      unequip(thing);\n      goto dispose_thing;\n   }\n\n:miss:\nbonus := 0;\n   miss := 1;\n   if (targ.position > POSITION_SLEEPING)\n   {\n      act(\"You throw your \" + thing.name + \" at $3n!\",\n          A_ALWAYS, self, null, targ, TO_CHAR);\n      act(\"$1n throws $1s \" + thing.name + \" at you!\",\n          A_ALWAYS, self, null, targ, TO_VICT);\n      act(\"$1n throws $1s \" + thing.name + \" at $3n!\",\n          A_SOMEONE, self, null, targ, TO_NOTVICT);\n\n      act(\"$3n dodges your throw!\",\n          A_ALWAYS, self, null, targ, TO_CHAR);\n      act(\"You skillfully dodge out of the path of $1n's \" + thing.name +\n          \"!\",\n          A_ALWAYS, self, null, targ, TO_VICT);\n      act(\"$1n misses as $3n skillfully dodges out of the way of $1s \" +\n          thing.name + \".\",\n          A_ALWAYS, self, null, targ, TO_NOTVICT);\n\n      goto dispose_thing;\n   }\n   else\n   {\n      act(\"You throw your \" + thing.name + \" at $3n but miss $3m completely!\",\n          A_ALWAYS, self, null, targ, TO_CHAR);\n      act(\"$1n throws $1s \" + thing.name + \" at $3n but misses completely!\",\n          A_SOMEONE, self, null, targ, TO_NOTVICT);\n      goto dispose_thing;\n   }\n\n\n:dispose_thing:\ndead_jim := dead_jim - bonus;\n\n   if (bonus == -1)\n   {\n      link(thing, self.outside);\n      quit;\n   }\n   else\n   {\n      mdam := rnd(0, 40 - (thing.value[1] + thing.value[2]));\n      thing.hp := thing.hp - mdam;\n      position_update(thing);\n\n/*      if ((bonus > 30) and (dead_jim > -10)) link(thing, targ)\n      else if ((bonus > 30) and (dead_jim == -10)) link(thing, self.outside);\n      else if ((bonus >30) and (dead_jim < -10))\n      {\n         pause;\n         thing := findunit(self, thing_name, FIND_UNIT_IN_ME, null);\n         if (tstr2 == \"\")\n         {\n            tstr := \"corpse of \" + tstr;\n            targ := findunit(self, tstr, FIND_UNIT_SURRO, null);\n            if (targ == null) link(thing, self.outside);\n            else link(thing, targ);\n         }\n         else if (tstr2 != \"\")\n         {\n            targ := findunit(self, \"corpse\", FIND_UNIT_SURRO, null);\n            if (targ == null) link(thing, self.outside);\n            else if (tstr2 in targ.outside_descr) link(thing, targ);\n            else link(thing, self.outside);\n         }\n         else link(thing, self.outside);\n\n      } */\n      if ((bonus > 30) and (dead_jim >= -10))\n        link (thing, targ);\n\n      else if ((bonus > 30) and (dead_jim < -10))\n        {\n        targ := findunit(self, \"corpse\", FIND_UNIT_SURRO, null);\n\n        if ((tstr2 != \"\") and (tstr2 in targ.outside_descr))\n            link(thing, targ);\n        else if ((tstr2 == \"\") and (tstr in targ.outside_descr))\n            link (thing, targ);\n\n        else link(thing, self.outside);\n        }\n\n      else\n        link(thing, self.outside);\n   }\n\n   quit;\n} dilend"
}