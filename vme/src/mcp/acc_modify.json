{
    "keyword": "acc_modify",
    "opcode": "DILSI_AMOD",
    "yacc_rule": "| DILSI_AMOD '(' coreexp ',' coreexp ')' ihold\n{\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'acc_modify' not an unitptr\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 2 of 'acc_modify' not an integer\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $7 + 1;\n        wtmp = &tmpl.core[$7];\n        bwrite_ubit8(&wtmp, DILI_AMOD);\n    }\n}",
    "dilfe_name": "dilfi_amod",
    "c_implementation": "void dilfi_amod(dilprg *p)\n{\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    if (dil_type_check(\"acc_modify\", p, 2, v1, TYPEFAIL_NULL, 1, DILV_UP, v2, FAIL_NULL, 1, DILV_INT))\n    {\n        if (g_cServerConfig.isAccounting() && v1->val.ptr && ((unit_data *)v1->val.ptr)->isPC())\n        {\n            if (p->frame[0].tmpl->zone->getAccessLevel() != 0)\n            {\n                szonelog(p->frame->tmpl->zone, \"DIL '%s' attempt to violate system access security (amod).\", p->frame->tmpl->prgname);\n                p->waitcmd = WAITCMD_QUIT;\n            }\n            else\n            {\n                if (v2->val.num > 0)\n                {\n                    account_insert(p->owner, (unit_data *)v1->val.ptr, v2->val.num);\n                }\n                else if (v2->val.num < 0)\n                {\n                    account_withdraw(p->owner, (unit_data *)v1->val.ptr, -v2->val.num);\n                }\n            }\n        }\n    }\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin restore_youth();\n   external\n      integer Rejuvenate(pc : unitptr, years : integer);\n\n   var\n      payer : unitptr;\n      drinker : unitptr;\n      s : string;\n      u : unitptr;\n      i : integer;\n      j : integer;\n      k : integer;\n      price : integer;\n      years : integer;\n      prevage : integer;\n      \n  code\n  {\n      interrupt(SFB_CMD, (command(\"drink\") and (argument in self.names) and (activator.type == UNIT_ST_PC)), drink);\n      heartbeat := 60 * PULSE_SEC;\n      j := 0;\n      \n      :start:\n      wait(SFB_TICK, TRUE);\n      j := j + 1;\n      if (j == 3)\n      {\n         subextra(self.extra, \"$interactions_1\");\n         addextra(self.extra, {\"$interactions_1\"}, \"\");\n      }\n      else if (j == 4)\n      {\n         subextra(self.extra, \"$interactions_2\");\n         addextra(self.extra, {\"$interactions_2\"}, \"\");        \n      }\n      if (j == 6)\n         j := 0;\n      goto start;\n      \n      \n      :drink:\n      block;\n      if (activator.level >= IMMORTAL_LEVEL)\n      {\n          sendtext(\"No need. You've already got everlasting life!<br/>\", activator);\n          goto start;\n      }\n      \n      price := atoi(self.extra.[\"$price_per_drink\"].descr);\n      years := atoi(self.extra.[\"$years_to_restore\"].descr);\n      \n      if ( (not(price)) or (not(years)) )\n      {\n        log(\"Missing extra on eternal spring. Make sure $price_per_drink and $years_to_restore extra exist on spring@youth.\");\n        act(\"You attempt to drink from the fountain and find that you just can't quite reach. Ask an immortal for help.\", A_SOMEONE, activator, self, null, TO_CHAR);\n        goto start;\n      }\n      /* if ( ((price) * 100) > activator.acc_balance)\n      {\n          act(\"Your will to drink from the $2N is strong but you realize you can't afford it.\", A_SOMEONE, activator, self, null, TO_CHAR);\n          goto start;\n      }*/\n\n      if (not ((activator.name in self.extra.[\"$interactions_1\"].names) or (activator.name in self.extra.[\"$interactions_2\"].names)))\n      {\n          addstring(self.extra.[\"$interactions_1\"].names, activator.name);\n          addstring(self.extra.[\"$interactions_2\"].names, activator.name);        \n          sendtext(\"<div class='cpr'>Drinking from the spring will make you younger by \" +  itoa(years) + \" mud years. If you are sure you want to continue, drink again.</div><br/>\", activator);\n          goto start;\n      }\n\n      prevage := activator.birth;\n      i := Rejuvenate(activator, years);\n\n      if (i == 0)\n      {    \n          act(\"You try to drink from the spring but find that it simply dissapears before it hits your lips.\", A_SOMEONE, activator,  self, null, TO_CHAR);\n          goto start;\n      }\n\n      drinker := activator;\n      substring(self.extra.[\"$interactions_1\"].names, drinker.name);\n      substring(self.extra.[\"$interactions_2\"].names, drinker.name);\n      act(\"You scoop a handful of water to your lips and sip, feeling renewed!\", A_ALWAYS, drinker, self, null, TO_CHAR);\n      act(\"$1n scoops a handful of water to $1s lips and instantly looks \" + itoa(years) + \" younger.\", A_SOMEONE, drinker, self, null, TO_REST);\n\n      log (self.name + \": \" + drinker.name + \" changed age to \" +  itoa((realtime - drinker.birth) / (SECS_PER_MUD_YEAR)));\n      \n      s := asctime(realtime);\n      s := s + \n      \" Drinker:\" + \n      drinker.name + \n      \" age from \" + \n      itoa((realtime - prevage) / (SECS_PER_MUD_YEAR)) + \n      \" to \" + \n      itoa((realtime-drinker.birth) / (SECS_PER_MUD_YEAR)) + \n      \" price: \" + \n      itoa(price) + \n      \" lifespan: \" + \n      itoa(drinker.lifespan) + \"<br/>\";\n      k := savestr(\"youth.log\", s, \"a\");\n      acc_modify(payer, -((price) * 100));\n      goto start;    \n  } dilend"
}