{
    "keyword": "send_done",
    "opcode": "DILSI_SNDDONE",
    "yacc_rule": "| DILSI_SNDDONE '(' coreexp ',' coreexp ',' coreexp ',' coreexp ',' coreexp ',' coreexp ',' coreexp ',' coreexp ')' ihold\n{\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'send_done' not a string\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_NULL && $5.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 2 of 'send_done' not an unit pointer\");\n    }\n    else if ($7.typ != DilVarType_e::DILV_NULL && $7.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 3 of 'send_done' not an unit pointer\");\n    }\n    else if ($9.typ != DilVarType_e::DILV_NULL && $9.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 4 of 'send_done' not an unit pointer\");\n    }\n    else if ($11.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 5 of 'send_done' not an integer\");\n    }\n    else if ($13.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 6 of 'send_done' not a string\");\n    }\n    else if ($15.typ != DilVarType_e::DILV_NULL && $15.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 7 of 'send_done' not an unit pointer\");\n    }\n    else if ($17.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 8 of 'send_done' not an integer (CMD_AUTO_ or 0)\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $19 + 1;\n        wtmp = &tmpl.core[$19];\n        bwrite_ubit8(&wtmp, DILI_SNDDONE);\n    }\n}",
    "dilfe_name": "dilfi_send_done",
    "c_implementation": "void dilfi_send_done(dilprg *p)\n{\n    command_info *cmd_ptr = nullptr;\n    dilval *v8 = p->stack.pop();\n    dilval *v7 = p->stack.pop();\n    dilval *v6 = p->stack.pop();\n    dilval *v5 = p->stack.pop();\n    dilval *v4 = p->stack.pop();\n    dilval *v3 = p->stack.pop();\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    if (dil_type_check(\"send_done\",\n                       p,\n                       8,\n                       v1,\n                       TYPEFAIL_NULL,\n                       1,\n                       DILV_SP,\n                       v2,\n                       TYPEFAIL_NULL,\n                       2,\n                       DILV_UP,\n                       DILV_NULL,\n                       v3,\n                       TYPEFAIL_NULL,\n                       2,\n                       DILV_UP,\n                       DILV_NULL,\n                       v4,\n                       TYPEFAIL_NULL,\n                       2,\n                       DILV_UP,\n                       DILV_NULL,\n                       v5,\n                       TYPEFAIL_NULL,\n                       1,\n                       DILV_INT,\n                       v6,\n                       TYPEFAIL_NULL,\n                       1,\n                       DILV_SP,\n                       v7,\n                       TYPEFAIL_NULL,\n                       2,\n                       DILV_UP,\n                       DILV_NULL,\n                       v8,\n                       TYPEFAIL_NULL,\n                       1,\n                       DILV_INT))\n    {\n        if (v8->val.num != CMD_AUTO_NONE)\n        {\n            switch (v8->val.num)\n            {\n                case CMD_AUTO_ENTER:\n                    send_done((unit_data *)v2->val.ptr,\n                              (unit_data *)v3->val.ptr,\n                              (unit_data *)v4->val.ptr,\n                              v5->val.num,\n                              &g_cmd_auto_enter,\n                              (const char *)v6->val.ptr,\n                              (unit_data *)v7->val.ptr);\n                    break;\n\n                default:\n                    slog(LOG_ALL,\n                         0,\n                         \"DIL %s@%s on %s: Unknown CMD_AUTO_ value %d.\",\n                         p->fp->tmpl->prgname,\n                         p->fp->tmpl->zone->getName(),\n                         p->sarg->owner->getFileIndexSymName(),\n                         v8->val.num);\n                    break;\n            }\n        }\n        else if ((cmd_ptr = (command_info *)search_trie((char *)v1->val.ptr, g_intr_trie)))\n        {\n            send_done((unit_data *)v2->val.ptr,\n                      (unit_data *)v3->val.ptr,\n                      (unit_data *)v4->val.ptr,\n                      v5->val.num,\n                      cmd_ptr,\n                      (const char *)v6->val.ptr,\n                      (unit_data *)v7->val.ptr);\n        }\n        else\n        {\n            szonelog(p->frame->tmpl->zone,\n                     \"send_done: DIL '%s' attempted to send a non-existent command '%s'.\",\n                     p->frame->tmpl->prgname,\n                     (char *)v1->val.ptr);\n        }\n    }\n    delete v1;\n    delete v2;\n    delete v3;\n    delete v4;\n    delete v5;\n    delete v6;\n    delete v7;\n    delete v8;\n}",
    "dil_example": "dilbegin aware do_reply(arg:string);\nvar\n\terr:integer;\n\tmsg_old:stringlist;\n\tmsg:string;\n\tmsg_time:string;\n\tu:unitptr;\n\txn:extraptr;\n\ti:integer;\n\tln:integer;\n\tmsg_num:integer;\n\ttemp:string;\n\tact_str:string;\n\tbuff:string;\n\tindexlist:stringlist;\n\tbrdname:string;\n\ncode\n{\n   if (self.type!=UNIT_ST_PC)\n      quit;\n\n   u:=self.inside;\n   while (u != null)\n\t{\n      if (u.type!=UNIT_ST_OBJ)\n      {\n         u:=u.next;\n         continue;\n      }\n      if (u.objecttype==ITEM_BOARD)\n         break;\n      u:=u.next;\n\t}\n\n   if (u==null)\n\t{\n      u:=self.outside.inside;\n      while (u!=null)\n\t\t{\n         if (u.type!=UNIT_ST_OBJ)\n         {\n            u:=u.next;\n            continue;\n         }\n      \tif (u.objecttype==ITEM_BOARD)\n\t\t   \tbreak;\n         u:=u.next;\n\t\t}\n   }\n\n   if (u.objecttype!=ITEM_BOARD)\n\t{\n      act (\"You have nothing to write on.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      quit;\n   }\n\n\tif (u.extra.[\"$BOARD_P_RES\"].descr!=\"\")\n   {\n      act_str := (string) u.extra.[\"$BOARD_P_RES\"].descr(self,u);\n      if (act_str!=\"\")\n      {\n         act(act_str, A_ALWAYS, self, null, null, TO_CHAR);\n         quit;\n      }\n   }\n   else\n   {\n\t\tif (self.level<10)\n      {\n      \tact(\"You need to be level 10 to post to this board.\", A_ALWAYS,self,null,null,TO_CHAR);\n   \t\tquit;\n      }\n   }\n\n   if (arg == \"\")\n\t{\n   \tact(\"Reply to which post?\", A_ALWAYS,self,null,null,TO_CHAR);\n\t\tquit;\n   }\n\n   msg_num:=atoi(arg);\n   xn:=\"$BOARD_MAX\" in u.extra;\n   if ((msg_num<=0) or (msg_num>atoi(xn.descr)))\n   {\n\t   brdname := xn.descr;\n\t   if (brdname == null)\n\t   \tbrdname := \"999\";\n      act (\"You must Reply to a post between 1 - \"+brdname+\".\",\n      A_ALWAYS,self,null,null,TO_CHAR);\n      quit;\n   }\n\n   brdname:=u.names.[length(u.names)-1];\n   err:=loadstr (brdname+\".idx\",temp);\n   if (err<0)\n\t{\n      log (\"02:  Error in boards on:  \"+brdname);\n      act (\"This board doesn't work report to an administrator.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n\t}\n\n   if (err==0)\n\t{\n      act (\"But the board is empty.\", A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n   }\n\n   indexlist:=split(temp,\"<br/>\");\n   ln:=length(indexlist);\n   if (msg_num>ln)\n\t{\n      act (\"That message exists only within the boundaries of your mind.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n\t}\n\n   if (ln>=atoi (xn.descr))\n\t{\n      act (\"You can't reply to that the board is full.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n\t}\n\n   msg_time:=indexlist.[msg_num-1];\n   msg_time:=getword( msg_time);\n   /*msg_old:=split(msg_time,\".\");*/\n\n\terr:=loadstr(brdname+\".\"+msg_time,buff);\n\tif (err==0)\n   {\n      sendtext (\"You can only reply to finished posts please wait and try again.<br/>\",self);\n      quit;\n   }\n   msg:=indexlist.[msg_num-1];\n   buff:=getword(msg);\n   msg_old:=split(msg,\" (\");\n   ln:=length(msg_old);\n   if (ln >2)\n\t{\n      i:=0;\n      while (i<ln-1)\n      {\n         if (i==0)\n            msg:=msg_old.[i];\n         else\n            msg:=msg+\" (\"+msg_old.[i];\n         i:=i+1;\n      }\n   }\n   else\n\t   msg:=msg_old.[0];\n\n   msg_time:=itoa(realtime);\n   msg:=msg_time+ \".re \"+msg+\" (\"+self.name+\")\";\n   msg:=\"<br/>\"+msg;\n   err:=savestr(brdname+\".idx\",msg,\"a\");\n   if (err<1)\n\t{\n\tlog (\"03:  Error in boards on:  \"+brdname);\n\tact (\"This board doesn't work report to an administrator.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\tgoto quitboard;\n\t}\ntemp:=indexlist.[msg_num-1];\nmsg:=getword(temp);\nact (\"You begin to reply to '\"+temp+\"'\",\nA_ALWAYS,self,null,null,TO_CHAR);\nact (\"$1n begins to write a message on the board.\",\nA_ALWAYS,self,null,null,TO_REST);\n\ninterrupt (SFB_MSG,((activator==self) and (argument==\"linkdead\")),clean_up);\n\tinterrupt(SFB_DEAD, activator == self, clean_up);\ninterrupt (SFB_COM,activator==self,clean_up);\ninterrupt (SFB_DONE, ((command(\"eat\")) and\n(medium==self)),clean_up);\n\n\tbeginedit (self);\n\twait(SFB_EDIT,self==activator) ;\nif (argument!=\"\")\n\t{\ntemp:=argument;\n\terr:=savestr(brdname+\".\"+msg_time+\".re\",temp,\"w\");\n\tif (err<1)\n\t\t{\n\t\tlog (\"04:  Error in boards on:  \"+brdname);\n\t\tact (\"This board doesn't work report to an administrator.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\tgoto quitboard;\n\t}\nact (\"Message:  \"+itoa(length(indexlist)+1)+\" posted.\",\n\tA_ALWAYS,self,null,null,TO_CHAR);\n\t}\nelse\n\t{\n:clean_up:\n\n\terr:=loadstr(brdname+\".idx\",buff);\n\tif (err<1)\n\t\tgoto quitboard;\n\tindexlist:=split(buff,\"<br/>\");\n\tmsg_num:=length(indexlist);\n\tmsg_num:=msg_num-1;\n\ntemp:=indexlist.[msg_num];\ntemp:=getword(temp);\nerr:=delstr (brdname+\".idx\");\nerr:=delstr (brdname+\".\"+temp);\nln:=length(indexlist);\ni:=0;\nbuff:=\"\";\nwhile (i<ln)\n\t{\n\tif (msg_num==i)\n\t\t{\n\t\ti:=i+1;\n\t\tcontinue;\n\t\t}\n\tif (length(buff)==0)\n\t\tbuff:=indexlist.[i];\n\telse\n\t\tbuff:=buff+\"<br/>\"+indexlist.[i];\n\ti:=i+1;\n\t}\n\n      err:=savestr(brdname+\".idx\",buff,\"w\");\n      if (err<1)\n      {\n         log (\"07:  Error in writing new idx file. in remove for \"+self.symname);\n         goto quitboard;\n      }\n      act (\"Blank posts are such a waste of space!  Removing.\", A_ALWAYS, self,null,null,TO_CHAR);\n   }\n\n   act(\"$1n finishes posting to the board.\", A_ALWAYS,self,null,null,TO_REST);\n\n   :quitboard:\n   send_done(\"reply\",self,null,u,0,arg,null, CMD_AUTO_NONE);\n   killedit(self);\n   quit;\n} dilend"
}