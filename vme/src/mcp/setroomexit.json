{
    "keyword": "setroomexit",
    "opcode": "DILSI_SETROOMEXIT",
    "yacc_rule": "| DILSI_SETROOMEXIT '(' coreexp ',' coreexp ',' coreexp ')' ihold\n{\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'setroomexit' not an unitptr\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 2 of 'setroomexit' not an integer\");\n    }\n    else if ($7.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 3 of 'setroomexit' not an unitptr\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $9 + 1;\n        wtmp = &tmpl.core[$9];\n        bwrite_ubit8(&wtmp, DILI_SETROOMEXIT);\n    }\n}",
    "dilfe_name": "dilfi_setroomexit",
    "c_implementation": "void dilfi_setroomexit(dilprg *p)\n{\n    /* setroomexit(room, direction, roomto) */\n    dilval *v3 = p->stack.pop();  // roomto\n    dilval *v2 = p->stack.pop();  // direction  \n    dilval *v1 = p->stack.pop();  // room\n\n    p->waitcmd--;\n\n    if (dil_type_check(\"setroomexit\", p, 1, v1, TYPEFAIL_NULL, 1, DILV_UP) &&\n        dil_type_check(\"setroomexit\", p, 1, v2, TYPEFAIL_NULL, 1, DILV_INT) &&\n        dil_type_check(\"setroomexit\", p, 1, v3, TYPEFAIL_NULL, 1, DILV_UP))\n    {\n        dil_getval(v1);\n        dil_getval(v2);\n        dil_getval(v3);\n\n        if (v1->val.ptr == nullptr)\n        {\n            szonelog(p->frame->tmpl->zone, \"DIL '%s' tried to call setroomexit() with null room pointer.\", p->frame->tmpl->prgname);\n        }\n        else if (!unit_room((unit_data *)v1->val.ptr))\n        {\n            szonelog(p->frame->tmpl->zone, \"DIL '%s' tried to call setroomexit() with non-room unit.\", p->frame->tmpl->prgname);\n        }\n        else if (v2->val.num < 0 || v2->val.num > MAX_EXIT)\n        {\n            szonelog(p->frame->tmpl->zone, \"DIL '%s' tried to call setroomexit() with invalid direction %d (valid: 0-%d).\", p->frame->tmpl->prgname, v2->val.num, MAX_EXIT);\n        }\n        else if (v3->val.ptr != nullptr && !unit_room((unit_data *)v3->val.ptr))\n        {\n            szonelog(p->frame->tmpl->zone, \"DIL '%s' tried to call setroomexit() with non-room destination.\", p->frame->tmpl->prgname);\n        }\n        else\n        {\n            room_data *room = (room_data *)v1->val.ptr;\n            room_data *roomto = (room_data *)v3->val.ptr;\n            int direction = v2->val.num;\n\n            // Get or create the room direction data\n            room_direction_data *exit_data = room->getRoomDirectionDataForExit(direction);\n            if (exit_data == nullptr)\n            {\n                // Create new exit if it doesn't exist\n                exit_data = new room_direction_data();\n                room->setRoomDirectionDataForExitTo(direction, exit_data);\n            }\n\n            // Set the destination room\n            exit_data->setToRoom(roomto);\n        }\n    }\n\n    delete v1;\n    delete v2;\n    delete v3;\n}",
    "dil_example": "dilbegin T016(tstno : integer);\nexternal\n   logtest(no : integer, ltype : integer, msg : string);\n\nvar\n   r : unitptr;\ncode\n{\n   logtest(tstno, LOGT_INFO, \"T016 running\");\n   r := findroom(\"testlabc@test\");\n\n   if (r.exit_to[DIR_NORTH] != null)\n   {\n      logtest(tstno, LOGT_INFO, \"There shouldn't be a room exit north\");\n      goto terminate;\n   }\n\n   if (r.exit_to[DIR_EAST] == null)\n   {\n      logtest(tstno, LOGT_INFO, \"east direction was null but should be set\");\n      goto terminate;\n   }\n\n   setroomexit(r, DIR_NORTH, r); // Point to self\n\n   if (r.exit_to[DIR_NORTH] != r)\n   {\n      logtest(tstno, LOGT_INFO, \"T016 north direction not set to self room\");\n      goto terminate;\n   }\n\n   r := null;\n   setroomexit(r, DIR_NORTH, r); // Drop the exit again\n \n   if (r.exit_to[DIR_NORTH] != null)\n   {\n      logtest(tstno, LOGT_INFO, \"T016 north direction not reset back to null\");\n      goto terminate;\n   }\n\n   logtest(tstno, LOGT_INFO, \"T016 Success\");\n   logtest(tstno, LOGT_INFO, \"Done\");\n   sendtoalldil(\"done\", \"T016@test\");\n   return;\n\n:terminate:\n   logtest(tstno, LOGT_INFO, \"T016 failed\");\n   sendtoalldil(\"fail\", \"T016@test\");\n   quit;\n} dilend"
}