{
    "keyword": "textformat",
    "opcode": "DILSE_TXF",
    "yacc_rule": "| DILSE_TXF '(' dilexp ')'\n{\n    INITEXP($$);\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'textformat' not string variable\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_SP;\n        add_code(&($$), &($3));\n        add_ubit8(&($$), DILE_TXF);\n    }\n    FREEEXP($3);\n}",
    "dilfe_name": "dilfe_txf",
    "c_implementation": "void dilfe_txf(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v1 = p->stack.pop();\n    char *dest = nullptr;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_NULL:\n        case DILV_FAIL:\n            v->type = DILV_FAIL; /* failed */\n            break;\n\n        case DILV_SP:\n            if (v1->val.ptr)\n            {\n                int n = str_escape_size((char *)v1->val.ptr, strlen((char *)v1->val.ptr));\n                CREATE(dest, char, n);\n\n                v->atyp = DILA_EXP;\n                v->type = DILV_SP;\n                str_escape_format((char *)v1->val.ptr, dest, n, FALSE);\n\n                v->val.ptr = str_dup(dest);\n                FREE(dest);\n            }\n            else\n            {\n                v->type = DILV_FAIL; /* NULL string */\n            }\n            break;\n\n        default:\n            v->type = DILV_ERR; /* wrong type */\n            break;\n    }\n    p->stack.push(v);\n    delete v1;\n}",
    "dil_example": "dilbegin aware Gold_bucket ();\nvar\nlen :integer;\n i,t:integer;\n buf:string;\n tmp:string;\n args:stringlist;\n\ncode\n{\n\ninterrupt (SFB_CMD, command(\"accadd\"),add_name);\ninterrupt (SFB_CMD, command(\"accdel\"),del_name);\n\n:start:\nwait (SFB_MSG, TRUE);\n\nif (argument !=\"lookin\" )\n goto start;\n\n\n if (length(self.extra.[\"$dlist\"].names)==1)\n  {\n  sendtext (\"No donations this year yet we still need $2400 per year.<br/>\",activator);\n goto start;\n }\n\n\n len:=length (self.extra.[\"$dlist\"].names);\n  buf:=\"As you look into the bucket you see the images of\";\n i:=1;\n while (i<len)\n  {\n  if (i==1)\n  {\n  if (i+1==len)\n   buf:=buf+\" \"+self.extra.[\"$dlist\"].names.[i]+\".  \";\n   else\n      buf:=buf+\" \"+self.extra.[\"$dlist\"].names.[i]+\", \";\n      }\n      else\n      {\n        if (i+1==len)\n   buf:=buf+\" and \"+ self.extra.[\"$dlist\"].names.[i]+\".  \";\n   else\n     buf:=buf+\" \"+self.extra.[\"$dlist\"].names.[i]+\", \";\n      }\n   t:=t+self.extra.[\"$dlist\"].vals.[i];\n   i:=i+1;\n  }\nif (t>2400)\n t:=2400;\n  t:=(t*100)/2400;\nif (t==100)\n                                                                                     buf :=buf +\"The images seem to fill the bucket, \"+\n                                                                                     \" with their grandeur and generosity.<br/>\";\nelse\n  buf:=buf+\"The images only seem to fill the bucket %\"+itoa(t)+\" of the way up. \"+\n  \" There is still room for your image if you are worthy.<br/>\";\n\n  buf:=textformat(buf);\n  sendtext(buf,activator);\n\ngoto start;\n\n:add_name:\nif (activator.level<240)\ngoto start;\nblock;\nif (argument==\"\")\n {\n sendtext (\"who do you want to add<br/>\",activator);\n goto start;\n }\n args:=getwords(argument);\n\n if (length (args) <2)\n  {\n  sendtext (\"Correct format is 'add &lt;amount&gt; &lt;person&gt;'<br/>\",activator);\n  goto start;\n  }\n\n  if (atoi(args.[0])==0)\n  {\n  sendtext (\"The first argument needs to be greater than 0<br/>\",activator);\n  goto start;\n  }\n\ntmp:=getword(argument);\ninsert(self.extra.[\"$dlist\"].names,length(self.extra.[\"$dlist\"].names),argument);\ninsert(self.extra.[\"$dlist\"].vals,length(self.extra.[\"$dlist\"].vals),atoi(args.[0]));\n\nstore (self,\"bucket\",TRUE);\ngoto start;\n:del_name:\n\nif (activator.level<200)\ngoto start;\nblock;\n\n\nif (argument==\"\")\n {\n sendtext (\"who do you want to delete<br/>\",activator);\n goto start;\n }\n\nt:=argument in self.extra.[\"$dlist\"].names;\nif (t>0)\n {\n remove (self.extra.[\"$dlist\"].names,t-1);\n  remove (self.extra.[\"$dlist\"].vals,t-1);\n   sendtext(argument +\" removed from the list<br/>\",activator);\n }\nelse\n{\nsendtext (\"That person is not in the list.<br/>\",activator);\n}\n\nstore (self,\"bucket\",TRUE);\ngoto start;\n} dilend"
}