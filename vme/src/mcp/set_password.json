{
    "keyword": "set_password",
    "opcode": "DILSI_SETPWD",
    "yacc_rule": "| DILSI_SETPWD '(' coreexp ',' coreexp ')' ihold\n{\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'set_password' not an unitptr\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 2 of 'set_password' not an integer\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $7 + 1;\n        wtmp = &tmpl.core[$7];\n        bwrite_ubit8(&wtmp, DILI_SETPWD);\n    }\n}",
    "dilfe_name": "dilfi_setpwd",
    "c_implementation": "void dilfi_setpwd(dilprg *p)\n{\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    if (dil_type_check(\"setpassword\", p, 2, v1, TYPEFAIL_NULL, 1, DILV_UP, v2, TYPEFAIL_NULL, 1, DILV_SP))\n    {\n        if (!((unit_data *)v1->val.ptr)->isPC())\n        {\n            dil_typeerr(p, \"Not a pc unit\");\n        }\n        else if (p->frame[0].tmpl->zone->getAccessLevel() > 0)\n        {\n            szonelog(p->frame->tmpl->zone, \"DIL '%s' attempt to violate system access security (setpassword).\", p->frame->tmpl->prgname);\n            p->waitcmd = WAITCMD_QUIT;\n        }\n        else if (v1->val.ptr && v2->val.ptr)\n        {\n            auto *pc = reinterpret_cast<pc_data *>(v1->val.ptr);\n            pc->setPassword(crypt(reinterpret_cast<char *>(v2->val.ptr), PC_FILENAME(pc)));\n        }\n    }\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin aware do_password(arg:string);\nvar\n   prmt:string;\n   firstpwd:string;\n   i:integer;\n   tlist:stringlist;\n\ncode\n{\n   if (excmdstr != \"password\")\n   {\n      sendtext (\"You must type 'password', no less to be able to set your password!<br/>\",self);\n      quit;\n   }\n\n   if (self.type != UNIT_ST_PC)\n      quit;\n\n   arg:=\"\";\n   prmt:=self.prompt;\n   self.prompt:=\"Enter new password:  \";\n   i:=dildestroy(\"send_prompt@update\",self);\n   dilcopy(\"send_prompt@update\",self);\n\n   wait(SFB_CMD, self==activator);\n   block;\n   tlist := getwords (excmdstr_case);\n\n   if (length(tlist) > 1)\n   {\n      sendtext (\"Password must be only one word.  Try again.<br/>\",self);\n      self.prompt:=prmt;\n      i:=dildestroy(\"send_prompt@update\",self);\n      dilcopy(\"send_prompt@update\",self);\n      quit;\n   }\n\n   if (length(excmdstr_case) < 5)\n   {\n      sendtext (\"Password to short. Password must be 5 characters or longer.  Try again.<br/>\",self);\n      self.prompt:=prmt;\n      i:=dildestroy(\"send_prompt@update\",self);\n      dilcopy(\"send_prompt@update\",self);\n      quit;\n   }\n\n   if (length(excmdstr_case) > 16)\n   {\n      sendtext (\"Password to long. Try again.<br/>\",self);\n      self.prompt:=prmt;\n      i:=dildestroy(\"send_prompt@update\",self);\n      dilcopy (\"send_prompt@update\",self);\n      quit;\n   }\n\n\tfirstpwd:=excmdstr_case;\n\tself.prompt:=\"Enter password again:  \";\n\n   wait (SFB_CMD,self==activator);\n   block;\n\n   if (strcmp(excmdstr_case,firstpwd)!=0)\n   {\n      sendtext (\"Passwords do not match try again.<br/>\",self);\n      self.prompt:=prmt;\n      i:=dildestroy(\"send_prompt@update\",self);\n      dilcopy (\"send_prompt@update\",self);\n      quit;\n   }\n\n   set_password(self,excmdstr_case);\n   sendtext (\"Password Changed.<br/>\",self);\n   self.prompt:=prmt;\n   i:=dildestroy(\"send_prompt@update\",self);\n   dilcopy(\"send_prompt@update\",self);\n   quit;\n} dilend"
}