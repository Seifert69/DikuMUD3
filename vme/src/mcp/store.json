{
    "keyword": "store",
    "opcode": "DILSI_STORA",
    "yacc_rule": "| DILSI_STORA '(' coreexp ',' coreexp ',' coreexp ')' ihold\n{\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'store' not an unitptr\");\n    }\n    if ($5.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 2 of 'store' not an string\");\n    }\n    if ($7.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 3 of 'store' not an integer\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $9 + 1;\n        wtmp = &tmpl.core[$9];\n        bwrite_ubit8(&wtmp, DILI_STORA);\n    }\n}",
    "dilfe_name": "dilfi_stora",
    "c_implementation": "void dilfi_stora(dilprg *p)\n{\n    dilval *v3 = p->stack.pop();\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    if (dil_type_check(\"storeall\", p, 3, v1, FAIL_NULL, 1, DILV_UP, v2, FAIL_NULL, 1, DILV_SP, v3, FAIL_NULL, 1, DILV_INT))\n    {\n        if (p->frame[0].tmpl->zone->getAccessLevel() > 10)\n        {\n            szonelog(p->frame->tmpl->zone, \"DIL '%s' attempt to violate system access security (storeall).\", p->frame->tmpl->prgname);\n            p->waitcmd = WAITCMD_QUIT;\n        }\n        else\n        {\n            if ((v1->val.ptr) && (v2->val.ptr))\n            {\n                if (!store_name_test((char *)v2->val.ptr))\n                {\n                    szonelog(p->frame->tmpl->zone, \"DIL '%s' attempt to store illegal file name (storeall).\", p->frame->tmpl->prgname);\n                }\n                else\n                {\n                    std::filesystem::path filename{p->frame[0].tmpl->zone->getDILFilePath().value_or(g_cServerConfig.getDILFileDir())};\n                    filename += \"/units/\";\n                    if (!std::filesystem::exists(filename))\n                    {\n                        std::filesystem::create_directories(filename);\n                    }\n                    filename += (char *)v2->val.ptr;\n\n                    if (v3->val.num >= 1)\n                    {\n                        if (((unit_data *)v1->val.ptr)->isRoom() || ((unit_data *)v1->val.ptr)->isPC())\n                        {\n                            szonelog(p->frame->tmpl->zone,\n                                     \"DIL '%s' attempt to save a container that is either a room or pc\",\n                                     p->frame->tmpl->prgname);\n                        }\n                        else\n                        {\n                            store_all_unit((unit_data *)v1->val.ptr, filename.c_str(), TRUE);\n                        }\n                    }\n                    else\n                    {\n                        store_all_unit((unit_data *)v1->val.ptr, filename.c_str(), FALSE);\n                    }\n                }\n            }\n        }\n    }\n    delete v1;\n    delete v2;\n    delete v3;\n}",
    "dil_example": "dilbegin aware email_list();\n\nvar\n   mail_expd  : extraptr;\n   mail_list  : stringlist;\n   new_list   : stringlist;\n   my_name    : string;\n   my_email   : string;\n   temp_str   : string;\n   temp_str2  : string;\n   public     : integer;\n\n   pc         : unitptr;\n\ncode\n{\n:init:\n   heartbeat := PULSE_SEC*2;\n   interrupt(SFB_MSG, (activator == self.outside), new_entry);\n\n:start:\n   wait(SFB_CMD, (command(\"public\") or command(\"show\")) and\n                  (activator.type == UNIT_ST_PC));\n\n   pc := activator;\n   secure(pc, lost_pc);\n\n   if (command(\"public\")) goto public_set;\n   if (command(\"show\")) goto show_info;\n   goto lost_pc;\n\n:public_set:\n   block;\n   temp_str2 := \"$\" + pc.name;\n   mail_expd := temp_str2 in self.extra;\n   if (mail_expd == null)\n   {\n      act(\"You do not have an entry on the email list. Please set an \" +\n          \"email using the mail command at Kurt.\",\n          A_ALWAYS, pc, null, null, TO_CHAR);\n      goto lost_pc;\n   }\n   mail_list := mail_expd.names;\n   my_name := mail_list.[1];\n   my_email := mail_list.[2];\n   public := atoi(mail_list.[3]);\n   if (public == 0)\n   {\n      substring(mail_list, itoa(0));\n      public := 1;\n      act(\"Your email address is now available to anyone who wants to \" +\n          \"see it.\",\n          A_ALWAYS, pc, null, null, TO_CHAR);\n   }\n   else\n   {\n      substring(mail_list, itoa(1));\n      public := 0;\n      act(\"Your email address is no longer visible to others.\",\n          A_ALWAYS, pc, null, null, TO_CHAR);\n   }\n\n   addstring(mail_list, itoa(public));\n   subextra(self.extra, pc.name);\n   addextra(self.extra, mail_list, \"\");\n   store(self,\"udgaard.mail_list_obj\",TRUE);\n   goto lost_pc;\n\n:show_info:\n   block;\n   temp_str2 := \"$\" + argument;\n   mail_expd := temp_str2 in self.extra;\n   if (mail_expd == null)\n   {\n      act(\"That person does not have a listing.\",\n          A_ALWAYS, pc, null, null, TO_CHAR);\n      goto lost_pc;\n   }\n   mail_list := mail_expd.names;\n   my_name := mail_list.[1];\n   my_email := mail_list.[2];\n   public := atoi(mail_list.[3]);\n   if ((public == 0) and (pc.level < 240))\n   {\n      act(my_name + \" has chosen not to have a publicly available email. \" +\n          \"Sorry.\",\n          A_ALWAYS, pc, null, null, TO_CHAR);\n   }\n   else\n   {\n      act(\"\" + my_name + \"'s email address is \" + my_email + \".\",\n          A_ALWAYS, pc, null, null, TO_CHAR);\n   }\n   goto lost_pc;\n\n:new_entry:\n   temp_str := argument;\n   temp_str2 := temp_str;\n   log(\"Got new entry - \" + temp_str);\n   my_name := getword(temp_str);\n   my_email := temp_str;\n   mail_expd :=( \"$\" + my_name) in self.extra;\n   if (mail_expd == null)\n   {\n      public := 0;\n      addstring(new_list, \"$\" + my_name);\n      addstring(new_list, my_name);\n      addstring(new_list, my_email);\n      addstring(new_list, itoa(public));\n      addextra(self.extra, new_list, \"\");\n   }\n   else\n   {\n      mail_list := mail_expd.names;\n      my_name := mail_list.[1];\n      my_email := mail_list.[2];\n      public := atoi(mail_list.[3]);\n\n      substring(mail_list, itoa(public));\n      substring(mail_list, my_email);\n      my_email := getword(temp_str2);\n      my_email := temp_str2;\n      addstring(mail_list, my_email);\n      addstring(mail_list, itoa(public));\n      subextra(self.extra, \"$\" + my_name);\n      addextra(self.extra, mail_list, \"\");\n   }\n\n   store(self,\"udgaard.mail_list_obj\",TRUE);\n   log (\"Stored after new entry.\");\n   goto lost_pc;\n\n:lost_pc:\n   unsecure(pc);\n   goto start;\n} dilend"
}