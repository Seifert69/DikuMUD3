{
    "keyword": "delunit",
    "opcode": "DILSE_DELUNIT",
    "yacc_rule": "| DILSE_DELUNIT '(' dilexp ')'\n{\n    INITEXP($$);\n\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'delunit' not a string\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n\n        make_code(&($3));\n        add_code(&($$), &($3));\n        add_ubit8(&($$), DILE_DELUNIT);\n    }\n\n    FREEEXP($3);\n}",
    "dilfe_name": "dilfe_delunit",
    "c_implementation": "void dilfe_delunit(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_INT;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_SP:\n            if (p->frame[0].tmpl->zone->getAccessLevel() > 10)\n            {\n                szonelog(p->frame->tmpl->zone, \"DIL '%s' attempt to violate system access security (delunit).\", p->frame->tmpl->prgname);\n                p->waitcmd = WAITCMD_QUIT;\n            }\n            else if (!store_name_test((char *)v1->val.ptr))\n            {\n                szonelog(p->frame->tmpl->zone, \"DIL '%s' attempted to delunit an illegal file name.\", p->frame->tmpl->prgname);\n                v->val.num = FALSE;\n            }\n            else\n            {\n                std::filesystem::path filename{p->frame[0].tmpl->zone->getDILFilePath().value_or(g_cServerConfig.getDILFileDir())};\n                filename += \"/units/\";\n                filename += (char *)v1->val.ptr;\n                v->val.num = remove(filename.c_str()) ? TRUE : FALSE;\n            }\n\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n\n    p->stack.push(v);\n    delete v1;\n}",
    "dil_example": "dilbegin cdelete(arg:string);\nexternal\n integer submember (s:string,pname:string);\n\tvar\n\t\tpc:unitptr;\n\t\ti:integer;\n\t\terr:integer;\n\t\tbuf:string;\n\t\tln:integer;\n\t\tcname:string;\n\t\tline:stringlist;\n\t\tclist:stringlist;\n\t\tfound:string;\n\t\tstrfile:stringlist;\n\ncode\n{\n\terr:=loadstr (\"clanlist.data\",buf);\n\tif (err<1)\n\t{\n\t\tlog (\"01:  Error in clanlist.data\");\n\t\tquit;\n\t}\n\n\tclist:=split(buf,\"\\n\");\n\tln:=length (clist);\n\tln:=ln-1;\n\tif (ln<1)\n\t{\n\t\tlog (\"02:  Error in clanlist.data\");\n\t\tsendtext (\"There is something wrong with clans talk with an admin about how you got this message.<br/>\",self);\n\t\tquit;\n\t}\n\n\ti:=0;\n\tbuf:=\"\";\n\tfound:=\"nope\";\n\twhile (i<ln)\n\t{\n\t\tif (arg==clist.[i])\n\t\t{\n\t\t\tfound:=\"yes\";\n\n\t\t\tcname:=clist.[i+2];\n\t\t\ti:=i+5;\n\t\t\tcontinue;\n\t\t}\n\t\tbuf:=buf+clist.[i]+\"\\n\"+clist.[i+1]+\"\\n\"+clist.[i+2]+\"\\n\"+clist.[i+3]+\"\\n\"+clist.[i+4]+\"\\n\";\n\t\ti:=i+5;\n\t}\n\n\tif (found==\"yes\")\n\t{\n\t\ti:=delstr(\"clanlist.data\");\n\t\ti:=savestr(\"clanlist.data\",buf,\"w\");\n\t}\n\telse\n\t{\n\t\tsendtext (\"No such clan found<br/>\",self);\n\t\tquit;\n\t}\n\n\tbuf:=\"\";\n\terr:=loadstr(arg,buf);\n\tif (err<1)\n\t{\n\t\tlog (\"01:  Error in\"+arg);\n\t\tquit;\n\t}\n\tclist:=null;\n\tclist:=split(buf,\"\\n\");\n\tln:=length(clist);\n\tln:=ln-1;\n\ti:=0;\n\twhile (i<ln)\n\t{\n\t\tline:=split(clist.[i],\":\");\n\t\tif (length(line)<2)\n\t\t{\n\t\t\ti:=i+1;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (length(line.[0])<1)\n\t\t{\n\t\t\ti:=i+1;\n\t\t\tcontinue;\n\t\t}\n\n\t\tpc:=ghead();\n\t\twhile (pc.type==UNIT_ST_PC)\n\t\t{\t\t\n\t\t\tif (pc.name==line.[0])\n\t\t\tbreak;\n\t\t\tpc:=pc.gnext;\n\t\t}\n\t\tlog (\"Deleting:  \");\n\t\tlog (line.[0]);\n\t\tif ((pc==null) or (pc.type!=UNIT_ST_PC))\n\t\tgoto pc_null;\n\n\t\tlog(\" online<br/>\");\n\t\terr:=submember(arg,line.[0]);\n\t\tpc.title:= \"<div class='cpr'></div><div class='bw'>Banished from </div>\"+cname+\" clan<div class='default'></div>\";\n\t\tsubextra (pc.extra,CLAN_NAME);\n\t\tsubextra (pc.extra,CLAN_RANK);\n\t\tsubextra (pc.extra,CLAN_SYMBOLIC);\n\n\t\tpc.hometown := \"temple@udgaard\";\n\t\tact (\"<div class='clan'>$3n has been removed from the clan.</div>\",\n\t\tA_ALWAYS,self,null,pc,TO_CHAR);\n\t\tact (\"<div class='clan'>You have been removed from the </div>\"+cname+\" clan.\",\n\t\tA_ALWAYS,pc,null,null,TO_CHAR);\n\t\ti:=i+1;\n\t\tcontinue;\n\n\t\t:pc_null:\n\t\tlog (\" off line<br/>\");\n\t\terr:=submember(arg,line.[0]);\n\t\tif (err==-1)\n\t\t{\n\t\t\tact (\"<div class='clan'>No such person found.</div>\",\n\t\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tact (\"<div class='clan'></div>\"+line.[0]+\" has been removed from the clan.\"\n\t\t\t,A_ALWAYS,self,null,pc,TO_CHAR);\n\t\t\terr:=savestr(\"clan.delete\",line.[0]+\"\\n\",\"a\");\n\t\t}\n\t\ti:=i+1;\n\t}\n\terr:=delstr(arg+\".rank\");\n\terr:=delstr(arg+\".money\");\n\terr:=delstr(arg);\n\terr:=delunit(arg+\".dc\");\n\tsendtext(\"The \"+arg+\" clan has been deleted.<br/>\",self);\n\tquit;\n} dilend"
}