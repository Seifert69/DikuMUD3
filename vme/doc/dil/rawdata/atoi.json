{
    "keyword": "atoi",
    "opcode": "DILSE_ATOI",
    "yacc_rule": "| DILSE_ATOI '(' dilexp ')'\n{\n    INITEXP($$);\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'atoi' not string\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Function is not _yet_ static */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n        make_code(&($3));\n        add_code(&($$), &($3));\n        add_ubit8(&($$), DILE_ATOI);\n    }\n    FREEEXP($3);\n}",
    "dilfe_name": "dilfe_atoi",
    "c_implementation": "void dilfe_atoi(dilprg *p)\n{\n    dilval *v = new dilval;\n    /* Conversion of strings to integers */\n    dilval *v1 = p->stack.pop();\n\n    switch (dil_getval(v1))\n    {\n        case DILV_NULL:\n        case DILV_FAIL:\n            v->type = DILV_FAIL; /* failed */\n            break;\n        case DILV_SP:\n            if (v1->val.ptr)\n            {\n                v->atyp = DILA_NONE;\n                v->type = DILV_INT;\n                v->val.num = atoi((char *)v1->val.ptr);\n            }\n            else\n            {\n                v->type = DILV_FAIL; /* failed */\n            }\n            break;\n        default:\n            v->type = DILV_ERR; /* Wrong type */\n            break;\n    }\n    p->stack.push(v);\n    delete v1;\n}",
    "dil_example": "dilbegin fnpri(FN_PRI_RESCUE-1) jailstay(du : integer);\nexternal\n   integer add_reward@justice(criminal_symname : string, criminal_idx : integer, crime_type : integer);\n   rem_db_entry@justice(criminal : unitptr, extra_type : string, juris : string);\n   getfrom_safe(prisoner : unitptr);\n   set_char_flags@justice(char : unitptr, setting : string);\nvar\n   sname : string;\n   jd : unitptr;\n   id : string;\n   juris : string; \n   k : string;\n   gold : integer;\n   g : string;\ncode\n{\n   heartbeat := PULSE_SEC * SECS_PER_MUD_HOUR;\n   juris := self.outside.zoneidx;\n   sname := self.outside.symname; // Get the jail symname\n\n   jd := findsymbolic(\"database@justice\");\n   id := \"$reward \"+ self.symname + \" \" + itoa(self.idx) + \" \"+ juris;\n   k := \"$reward \"+ juris;\n     \n   // Change player arrest descr to reflect that the char is in jail.\n   //\n   jd := findsymbolic(\"database@justice\");\n   \n   if( \"$reward\" in self.extra)\n   {\n      jd.extra.[id].names.[4] := \"-1\";\n      self.extra.[k].names.[4] := \"-1\";\n      jd.extra.[id].descr := self.name+\" is currently serving time in jail.\";\n   }\n\n \n  :loop:\n   pause;\n   if (sname != self.outside.symname)\n   {\n      // Player has escaped from jail\n      jd := findsymbolic(\"database@justice\");\n      jd.extra.[id].names.[4] := \"65\";\n      self.extra.[k].names.[4] := \"65\";\n      gold := atoi(jd.extra.[id].names.[2]); \n      g := moneystring(gold,1); \n      jd.extra.[id].descr := \"A reward of \" + g + \" has been offered for the head of \"+self.name;\n      set_char_flags@justice(self, \"wanted\");\n      log(\"Jailbreak: \"+self.name+\" has escaped from the \"+ juris +\" jail.\"); \n      quit;\n   }\n\n   if(\"$reward\" in self.extra)\n   {\n      jd := findsymbolic(\"database@justice\");\n      jd.extra.[id].names.[4] := \"-1\";\n      jd.extra.[id].descr := self.name+\" is currently serving time in jail. \"+itoa(du)+\" hours remaining\";\n   }\n\n   if ((du % 4) == 0)\n     send(\"jailfood\");\n\n   if (du == 24)\n   {\n      act(\"At last! The very last day of your term!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n   }\n   else if (du == 12)\n   {\n      act(\"Only half a day left 'till your freedom!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n   }\n   else if (du <= 1)\n     goto release;\n   else\n   {\n      act(\"You make another mark on the wall. Only \"+itoa(du)+\" hours till freedom!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n   }\n   \n   du := du - 1;\n   goto loop;\n\n\n   /* Get thrown out of jail */\n   :release:\n   act(\"Your term is over! You are thrown out of the jail and sent home.\",\n       A_ALWAYS, self, null, null, TO_CHAR);\n   getfrom_safe(self);\n   link(self, findroom(\"accuse_room@\" + juris));\n   rem_db_entry@justice(self, \"$reward\", juris);\n   set_char_flags@justice(self, \"arrest\");\n   quit;\n} dilend"
}