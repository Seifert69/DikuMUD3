{
    "keyword": "visible",
    "opcode": "DILSE_VISI",
    "yacc_rule": "| DILSE_VISI '(' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n    $$.boolean = 1;\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'visible' not a unitptr\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 2 of 'visible' not a unitptr\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n        make_code(&($3));\n        make_code(&($5));\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_ubit8(&($$), DILE_VISI);\n    }\n    FREEEXP($3);\n    FREEEXP($5);\n}",
    "dilfe_name": "dilfe_visi",
    "c_implementation": "void dilfe_visi(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_INT;\n    switch (dil_getval(v1))\n    {\n        case DILV_UP:\n            if (!v1->val.ptr || !((unit_data *)v1->val.ptr)->isChar())\n            {\n                v->type = DILV_FAIL;\n            }\n            else\n            {\n                switch (dil_getval(v2))\n                {\n                    case DILV_UP:\n                        if (!v2->val.ptr)\n                        {\n                            v->type = DILV_FAIL;\n                        }\n                        else\n                        {\n                            v->val.num = CHAR_CAN_SEE((unit_data *)v1->val.ptr, (unit_data *)v2->val.ptr);\n                        }\n                        break;\n                    case DILV_FAIL:\n                    case DILV_NULL:\n                        v->type = DILV_FAIL;\n                        break;\n                    default:\n                        v->type = DILV_ERR;\n                        break;\n                }\n            }\n\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin fnpri(FN_PRI_MISSION) janitors(rate: integer);\nvar\n   trash : unitptr;\n   s : string;\n   sl : stringlist;\n   msgs : stringlist;\n   songs : stringlist;\n   sing1 : stringlist;\n   move : stringlist;\n   msg : integer;\n   msg2 : integer;\n   obj : unitptr;\n   intg : integer;\n   inits: integer; // Boolean (added by S)\n\ncode\n{\n   if (inits == FALSE)\n   {\n      obj := load (\"tbag@midgaard\");\n      link (obj, self);\n      obj := null;\n      inits := TRUE;\n   }\n\n   heartbeat := PULSE_SEC*rate;\n   msgs := {\"Ewww, a corpse.\",\n      \"Geez, people just leave these things lying around these days.\",\n      \"I wonder who killed that poor sucker.\",\n      \"I always knew that guy was a pansy.\",\n      \"He had it coming to him anyhow.\"};\n   songs:={\"sing1\"};\n   sing1:={\"I can see a bare-bottomed mandril,\",\n      \"Slyly eyeing his upper nostril,\",\n      \"If he jumps inside there too,\",\n      \"I really won't know what to do,\",\n      \"I'll be a proud possessor of a kind of nasal zoo,\",\n      \"A nasal zoo.\",\n      \"I've got a ferret sticking up my nose,\",\n      \"And what is worse it constantly explodes,\",\n      \"Ferrets don't explode you say,\",\n      \"But it happened nine times yesterday,\",\n      \"And I should know 'cause each time,\",\n      \"I was standing in the way.\",\n      \"I've got a ferret sticking up my nose,\",\n      \"I've got a ferret sticking up my nose,\",\n      \"How it got there I can't tell,\",\n      \"But now it's there it hurts like hell,\",\n      \"And what is more it radically affects my sense of smell.\"};\n\n   move := {\"fear\",\"cringe\",\"cringe\"};\n\n:start:\n:collect:\n   pause;\n   foreach (UNIT_ST_OBJ, trash)\n   {\n      if (not findsymbolic(self, \"tbag@midgaard\", FIND_UNIT_IN_ME)) \n         goto s_break;\n\n      if (self.outside.flags & UNIT_FL_NO_BURY) continue;\n      if (trash.flags & UNIT_FL_BURIED) continue;\n      if (not isset (trash.manipulate, MANIPULATE_TAKE)) continue;\n      if (not visible(self,trash)) continue;\n      if (can_carry (self, trash, 1) > 0) continue; // Can't carry\n      if (\"treasure\" == trash.zoneidx) continue;\n      if ((trash.objecttype == ITEM_CONTAINER) or( trash.objecttype == ITEM_BOAT))\n         continue;\n      if ((trash.nameidx + trash.zoneidx == \"corpsebasis\") and (trash.value[2] == 0))\n      {\n         if (isset (self.outside.flags, UNIT_FL_NO_BURY)) continue;\n         secure(trash, collect);\n         pause;\n         unsecure(trash);\n         if (trash.inside != null)\n         {\n            msg := rnd(0, (length(msgs)-1));\n            exec(\"say \"+msgs.[msg], self);\n            exec(\"get all from corpse\", self);\n            exec(\"bury \"+trash.name, self);\n            exec(\"put all in bag\", self);\n            continue;\n         }\n\n         if ((trash.nameidx + trash.zoneidx == \"corpsebasis\") and (trash.value[2] == 0) and (trash.inside == null)) \n            goto npc;\n         else\n         {\n            :npc:\n            msg := rnd(0, (length(msgs)-1));\n            exec(\"say \"+msgs.[msg], self);\n            exec(\"bury \"+trash.name, self);\n            continue;\n         }\n      }\n      if ((trash.nameidx + trash.zoneidx == \"corpsebasis\") and (trash.value[2] == 0) and (trash.inside == null))\n      {\n         secure(trash, collect);\n         pause;\n         unsecure(trash);\n         msg := rnd(0, (length(msgs)-1));\n         exec(\"say \"+msgs.[msg], self);\n         exec(\"bury \"+trash.name, self);\n         continue;\n      }\n      if ((trash.nameidx + trash.zoneidx == \"corpsebasis\") and (trash.value[2] == 1) and (trash.inside != null))\n      {\n         if (\"$owner notified\" in trash.extra) \n            continue;\n         else\n         {\n            sl := getwords(trash.name);\n            s := sl.[2];\n            pause;pause;\n            exec (\"tell \"+s+\" Your corpse is at \"     +self.outside.title +\", please pick it up.\", self);\n            addextra(trash.extra, {\"$owner notified\"}, \"\");\n            continue;\n         }\n      }\n\n      if ((trash.nameidx + trash.zoneidx == \"corpsebasis\") and (trash.value[2] == 1) and (trash.inside == null))\n      {\n         secure(trash, collect);\n         pause;\n         unsecure(trash);\n         exec(\"bury \"+trash.name, self);\n         continue;\n      }\n      if ((trash.nameidx+\"@\"+trash.zoneidx == \"slime@basis\"))\n      {\n         secure(trash, collect);\n         pause;\n         exec(\"say Ewww, slime!\", self);\n         msg2 := rnd(0, (length(move)-1));\n         exec(move.[msg2], self);\n         pause;\n         exec(\"emote utters the words, 'fadiz univisa!'..\", self);\n         act(\"$2n de-materializes before your very eyes.\", A_ALWAYS, self, trash, null, TO_ALL);\n         unsecure(trash);\n         destroy(trash);\n         continue;\n      }\n      if ((trash.nameidx+\"@\"+trash.zoneidx == \"head@death\"))\n      {\n         secure(trash, collect);\n         pause;\n         exec(\"say looks like someone lost their head.\", self);\n         exec(\"chuckle\", self);\n         pause;\n         exec(\"emote utters the words, 'fadiz univisa!'..\", self);\n         act(\"$2n de-materializes before your very eyes.\", A_ALWAYS, self, trash, null, TO_ALL);\n         unsecure(trash);\n         destroy(trash);\n         continue;\n      }\n\n      if ((trash.objecttype == ITEM_FOOD) or (trash.objecttype == ITEM_DRINKCON))\n      {\n         secure(trash, collect);\n         pause;\n         exec(\"get \"+trash.name, self);\n         if (trash.value[3] > 0)\n         {\n            exec(\"say This \"+trash.name+\" is unfit for consumption!\", self);\n            act(\"$1n heaves the $2n into the distance.\", A_ALWAYS, self, trash, null, TO_ALL);\n            unsecure(trash);\n            destroy(trash);\n            goto no_food;\n         }\n\n         unsecure(trash);\n         dilcopy(\"rotaway@midgaard()\",trash);\n         act(\"$1n donates $2n to a worthy cause.\", A_ALWAYS, self, trash, null, TO_ALL);\n         link(trash, findroom(\"jandump@midgaard\"));\n\n         :no_food:\n         pause;\n         continue;\n      }\n      else\n      {\n         secure(trash, collect);\n         exec(\"get \"+trash.name, self);\n         if (\"bag\" in trash.names)\n         {\n            //   dilcopy(\"rotaway@midgaard()\",trash);\n            // log(\"should be dilcopying 2\");\n            unsecure(trash);\n            exec(\"put \"+ trash.name +\" in 2.bag\",self);\n            pause;\n            continue;\n         }\n         else\n         {\n            // dilcopy(\"rotaway@midgaard()\",trash);\n            // log(\"should be dilcopying 3\");\n            unsecure(trash);\n            exec(\"put \"+ trash.name +\" in bag\",self);\n            pause;\n            continue;\n         }\n      }\n      pause;pause;\n   } // Foreach\n\n   goto start;\n\n:s_break:\n   addextra (self.extra, {\"$block wander\"}, \"\");\n   exec(\"say Where did my trash bag get to?\", self);\n   pause;\n   exec(\"boggle self\", self);\n   pause;pause;pause;pause;\n   exec(\"say Well, good time for a break I guess.\", self);\n   pause;\n   exec(\"rest\", self);\n   pause;pause;pause;pause;pause;\n   exec(\"emote clears his throat in preparation for a song.\", self);\n   pause;\n\n   intg := 0;\n   while (intg < length(sing1))\n   {\n      exec(\"emote sings, '\"+sing1.[intg]+\"'\", self);pause;\n      intg := intg+1;\n   }\n\n   pause;pause;pause;pause;pause;pause;\n   exec(\"say I'd better get back to work before I get in trouble.\", self);\n   pause;pause;\n   exec(\"stand\", self);\n   pause;pause;\n   link(load(\"tbag@midgaard\"),self);\n   exec(\"emote gets a trash bag from his back pocket.\", self);\n   pause;\n   exec(\"say Rule number one: always carry a spare.\", self);\n   exec(\"snicker\", self);\n   pause;pause;pause;pause;\n   subextra (self.extra,\"$block wander\");\n   goto start;\n} dilend"
}