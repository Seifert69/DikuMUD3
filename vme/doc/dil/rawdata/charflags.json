{
    "keyword": "charflags",
    "opcode": "DILSF_AFF",
    "yacc_rule": "| DILSF_AFF /* .affected */\n{\n    INITEXP($$);\n    $$.rtyp = DilVarType_e::DILV_UP;\n    $$.typ = DilVarType_e::DILV_INT;\n    $$.dsl = DSL_LFT;\n    $$.num = DILF_AFF;\n}",
    "dilfe_name": "DILF_AFF",
    "c_implementation": "case DILF_AFF:\n            switch (dil_getval(v1))\n            {\n                case DILV_NULL: /* not applicable */\n                case DILV_FAIL:\n                    v->type = DILV_FAIL; /* not applicable */\n                    break;\n                case DILV_UP:\n                {\n                    auto *character = reinterpret_cast<char_data *>(v1->val.ptr);\n                    if (character && character->isChar())\n                    {\n                        v->atyp = DILA_NONE;\n                        v->type = DILV_UINT4R;\n                        v->ref = character->getCharacterFlagsPtr();\n                    }\n                    else\n                    {\n                        v->type = DILV_FAIL;\n                    }\n                }\n                break;\n\n                default:\n                    v->type = DILV_ERR; /* wrong type */\n                    break;\n            }\n            break;",
    "dil_example": "dilbegin fnpri(FN_PRI_RESCUE-1) arrest_check(office : string);\nexternal\n    guard_arrest(office : string, prisoner : unitptr);\n    cuff_target(deputy : unitptr, targ : unitptr, cuffs : unitptr);\n    integer check_outlaw@justice(char : unitptr, juris : string);\n    string get_juris@justice();\nvar\n    u : unitptr;\n    outlaw_status : integer;\n    juris : string;\ncode\n{\n    on_activation((self.position <= POSITION_SLEEPING) or (self.position == POSITION_FIGHTING), skip);\n\n:loop:\n    wait(SFB_CMD, activator.charflags & CHAR_OUTLAW);\n    if (activator == self)\n        goto loop;\n    juris := get_juris@justice();\n    outlaw_status := check_outlaw@justice(activator, juris);\n    if (outlaw_status == 0)\n        goto loop; \n\n    u := equipment(activator,  WEAR_WRIST_R);\n\n    if (u)\n        if ((u.nameidx == \"cuffs\") and (u.zoneidx == \"midgaard\"))\n            goto loop;\n\n    if (outlaw_status == 1)  //if (activator.charflags & CHAR_PROTECTED)\n    {\n        u := load(\"cuffs@midgaard\");\n\n        cuff_target(self, activator, u);\n\n        guard_arrest@midgaard(office, activator);\n    }\n    else\n    {\n        unset(activator.charflags, CHAR_SELF_DEFENCE);\n        // If we have several chars with the same name, this causes havoc\n        //     exec(\"kill \"+activator.name, self);\n        set_fighting(self, activator);\n    }\n\n    goto loop;\n} dilend"
}