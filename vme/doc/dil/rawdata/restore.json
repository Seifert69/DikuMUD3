{
    "keyword": "restore",
    "opcode": "DILSE_RESTA",
    "yacc_rule": "| DILSE_RESTA '(' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'restore' not a string\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_UP && $5.typ != DilVarType_e::DILV_NULL)\n    {\n        dilfatal(\"Arg 2 of 'restore' not a unitptr or null\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_UP;\n\n        make_code(&($3));\n        make_code(&($5));\n\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_ubit8(&($$), DILE_RESTA);\n    }\n\n    FREEEXP($3);\n    FREEEXP($5);\n}",
    "dilfe_name": "dilfe_resta",
    "c_implementation": "void dilfe_resta(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_UP;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_SP:\n            switch (dil_getval(v2))\n            {\n                case DILV_UP:\n                case DILV_NULL:\n                {\n                    if (p->frame[0].tmpl->zone->getAccessLevel() > 10)\n                    {\n                        szonelog(p->frame->tmpl->zone,\n                                 \"DIL '%s' attempt to violate system access security (restorall).\",\n                                 p->frame->tmpl->prgname);\n                        p->waitcmd = WAITCMD_QUIT;\n                        break;\n                    }\n\n                    if (!store_name_test((char *)v1->val.ptr))\n                    {\n                        szonelog(p->frame->tmpl->zone, \"DIL '%s' attempted to restore an illegal file name.\", p->frame->tmpl->prgname);\n                        v->val.ptr = nullptr;\n                        break;\n                    }\n\n                    std::filesystem::path filename{p->frame[0].tmpl->zone->getDILFilePath().value_or(g_cServerConfig.getDILFileDir())};\n                    filename += \"/units/\";\n                    filename += (char *)v1->val.ptr;\n                    if (v2->val.ptr)\n                    {\n                        v->val.ptr = restore_all_unit(filename.c_str(), (unit_data *)v2->val.ptr);\n                    }\n                    else\n                    {\n                        v->val.ptr = restore_all_unit(filename.c_str(), p->owner);\n                    }\n                    if (v->val.ptr == nullptr)\n                    {\n                        v->type = DILV_NULL;\n                    }\n                }\n                break;\n                case DILV_FAIL:\n                    v->type = DILV_FAIL;\n                default:\n                    v->type = DILV_ERR;\n                    break;\n            }\n\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin buck_load ();\nvar\n waist:unitptr;\n buck:unitptr;\ncode\n{\nbuck:=restore(\"bucket\",null);\n\nif (buck==null)\n {\nbuck:=load(\"moot_buck@udgaard\");\n}\nlink (buck, self);\nquit;\n} dilend"
}