{
    "keyword": "mapy",
    "opcode": "DILSF_MAPY",
    "yacc_rule": "| DILSF_MAPY /* .mapy */\n{\n    INITEXP($$);\n    $$.rtyp = DilVarType_e::DILV_UP;\n    $$.typ = DilVarType_e::DILV_INT;\n    $$.dsl = DSL_LFT;\n    $$.num = DILF_MAPY;\n}",
    "dilfe_name": "DILF_MAPY",
    "c_implementation": "case DILF_MAPY:\n            switch (dil_getval(v1))\n            {\n                case DILV_NULL:\n                case DILV_FAIL:\n                    v->type = DILV_FAIL; /* not applicable */\n                    break;\n                case DILV_UP:\n                {\n                    v->atyp = DILA_NORM;\n                    v->type = DILV_INT;\n                    auto *room = reinterpret_cast<room_data *>(v1->val.ptr);\n                    if (room && room->isRoom())\n                    {\n                        v->val.num = room->getMapYCoordinate();\n                    }\n                    else\n                    {\n                        v->val.num = -1;\n                    }\n                }\n                break;\n\n                default:\n                    v->type = DILV_ERR; /* wrong type */\n                    break;\n            }\n            break;",
    "dil_example": "dilbegin string room_content(looker : unitptr, room : unitptr, arg : string);\nexternal\n   string carried_by(l2 : unitptr, u:unitptr);\n   string get_pos (l3 : unitptr, u:unitptr);\n   string display_exits (l4 : unitptr, u:unitptr);\n   string exits_h(looker : unitptr);\n\nvar\n   u             : unitptr;\n   temp_pos      : string;\n   pc            : stringlist;\n   npc           : stringlist;\n   obj           : stringlist;\n   n_npc         : stringlist;\n   n_obj         : stringlist;\n   i             : integer;\n   temp          : string;\n   temp_in       : integer;\n   buff          : string;\n   tpbuff        : string;\n   snpc:string;\n   spc:string;\n   sobj:string;\n   inpc:integer;\n   ipc:integer;\n   iobj:integer;\n\n   bObj  : integer;\n   bChar : integer;\n   bRoom : integer;\ncode\n{\n   if (arg == \":chars:\")\n   {\n      bObj := FALSE;\n      bChar := TRUE;\n      bRoom := FALSE;\n   }\n   else if (arg == \":objects:\")\n   {\n      bObj := TRUE;\n      bChar := FALSE;\n      bRoom := FALSE;\n   }\n   else\n   {\n      bObj := TRUE;\n      bChar := TRUE;\n      bRoom := TRUE;\n   }\n\n   if (room.type != UNIT_ST_ROOM)\n   {\n      log(\"Non-room entered room_content dil in look\");\n      quit;\n   }\n\n   temp := \"\";\n   tpbuff := \"\";\n   buff := \"\";\n\n   if (bRoom)\n   {\n      temp_pos := \"\";\n      if (room.mapx != -1)\n         temp_pos := \" map='\"+itoa(room.mapx) + \",\" + itoa(room.mapy)+\"'\";\n\n      if (looker.level >= IMMORTAL_LEVEL)\n         temp := \" [\" + room.nameidx + \"@\" + room.zoneidx + \"]\";\n\n      buff := \"<h1 class='room_title' zone='\"+room.zoneidx+\"' exits='\" + exits_h(looker) + \"'\"+ temp_pos + \">\" +\n                        room.title + temp + \"</h1><br/>\";\n      temp_pos := \"\";\n\n\n      if (looker.type == UNIT_ST_PC)\n      {\n         if (not (isset(looker.pcflags, PC_BRIEF) and (arg == \":brief:\")))\n            buff := buff + \"<div class='room_descr'>\" + room.inside_descr + \"</div><br/>\";\n      }\n      else\n         buff := buff + \"<div class='room_descr'>\" + room.inside_descr + \"</div><br/>\";\n\n      temp := \"\";\n      buff := buff + display_exits(looker, room);\n   }\n\n   u := room.inside;\n   while (u != null)\n   {\n      if ((u==looker) or (u == looker.outside) or (isset(u.flags,UNIT_FL_BURIED)))\n      {\n         u := u.next;\n         continue;\n      }\n\n      if ((u.type == UNIT_ST_PC) and (bChar))\n      {\n         /*if (u.outside!=looker.outside)\n           {u := u.next;\n            continue;\n         }*/\n\n\t\t   if (visible(looker, u) and ((not (isset(u.charflags, CHAR_HIDE)))) or (looker.level>=IMMORTAL_LEVEL))\n         {\n            if (isset(u.flags, UNIT_FL_TRANS) and (not isset(u.openflags, EX_CLOSED))) // MS2020\n               tpbuff := carried_by(looker, u);\n\n            temp_pos := get_pos(looker, u);\n\n            if (length (tpbuff))\n            {\n               tpbuff := u.name + \" carries:<br/>\" + tpbuff;\n               if (u.level >= IMMORTAL_LEVEL)\n               {\n                  temp := \"<div class='immort_title'>\" + u.name + \" \" + u.title + temp_pos;\n\n                  if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n                     temp := temp + \" (wizinv)\";\n\n                  if ((isset(u.charflags, CHAR_HIDE)) and (looker.level  >= IMMORTAL_LEVEL))\n                     temp := temp + \" (hidden)\";\n\n                  temp := temp + \"</div><br/>\";\n\n                  temp := temp + tpbuff;\n               }\n               else\n               {\n                  temp := \"<div class='pc_title'>\" + u.name + \" \" + u.title + temp_pos;\n\n                  if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n                     temp := temp + \" (wizinv)\";\n\n                  if ((isset(u.charflags, CHAR_HIDE)) and (looker.level  >= IMMORTAL_LEVEL))\n                     temp := temp + \" (hidden)\";\n\n                  temp := temp + \"</div><br/>\" + tpbuff;\n               }\n\n               addstring(pc, temp);\n            }\n            else\n            {\n               if (u.level >= IMMORTAL_LEVEL)\n               {\n                  temp := \"<div class='immort_title'>\" + u.name + \" \" + u.title + temp_pos;\n                  if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n                     temp := temp + \" (wizinv)\";\n\n                  if ((isset(u.charflags, CHAR_HIDE)) and (looker.level  >= IMMORTAL_LEVEL))\n                     temp := temp + \" (hidden)\";\n\n                  temp := temp + \"</div><br/>\";\n               }\n               else\n               {\n                  temp := \"<div class='pc_title'>\" + u.name + \" \" + u.title + temp_pos;\n                  if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n                     temp := temp + \" (wizinv)\";\n\n                  if ((isset(u.charflags, CHAR_HIDE)) and (looker.level  >= IMMORTAL_LEVEL))\n                     temp := temp + \" (hidden)\";\n\n                  temp := temp + \"</div><br/>\";\n               }\n\n               addstring (pc, temp);\n            }\n         }\n         else if ((isaff(looker, ID_DETECT_LIFE)) and (u.level <IMMORTAL_LEVEL))\n         {\n            temp := \"You sense a hidden life form in the room.</div>\";\n            temp_in:=textformat(temp) in npc;\n\n            if (temp_in > 0)\n            {\n               i := atoi(n_npc.[temp_in - 1]) + 1;\n               n_npc.[temp_in - 1] := itoa(i);\n            }\n            else\n            {\n               addstring(npc, textformat(temp));\n               addstring(n_npc, \"1\");\n            }\n         }\n      }\n      else if ((u.type == UNIT_ST_NPC) and (bChar))\n      {\n         /*   if (u.outside!=looker.outside)\n               {u := u.next;\n                  continue; }*/\n\n         if ((visible (looker, u)) and ((not (isset(u.charflags, CHAR_HIDE)))) or (looker.level>=IMMORTAL_LEVEL))\n         {\n            if (u.position != POSITION_STANDING)\n            {\n               temp_pos := get_pos(looker, u);\n               temp := u.title + temp_pos;\n            }\n            else\n               temp:=u.outside_descr;\n\n            if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n               temp := temp + \" (wizinv)\";\n\n            if ((isset(u.charflags, CHAR_HIDE)) and (looker.level >= IMMORTAL_LEVEL))\n               temp := temp + \" (hidden)\";\n\n            if (isset(u.flags, UNIT_FL_TRANS) and (not isset(u.openflags, EX_CLOSED))) // MS2020\n               tpbuff := carried_by(looker, u);\n\n            if (length(tpbuff))\n            {\n               tpbuff := sact(\" $2n carries:<br/>\" + tpbuff, A_SOMEONE, looker, u, null, TO_CHAR);\n               temp := temp  + tpbuff;\n            }\n\n\t\t\t   temp_in:=temp in npc;\n\n            if (temp_in > 0)\n            {\n               i := atoi(n_npc.[temp_in - 1]) + 1;\n               n_npc.[temp_in - 1] := itoa(i);\n            }\n            else\n            {\n               addstring(npc, temp);\n               addstring(n_npc, \"1\");\n            }\n         }\n         else if ((isaff(looker, ID_DETECT_LIFE)) and (isset(u.charflags,CHAR_HIDE)) and (u.level < IMMORTAL_LEVEL))\n         {\n            temp := \"You sense a hidden life form in the room.<br/>\";\n\n            temp_in:=temp in npc;\n\n            if (temp_in > 0)\n            {\n               i := atoi(n_npc.[temp_in - 1]) + 1;\n               n_npc.[temp_in - 1] := itoa(i);\n            }\n            else\n            {\n               addstring(npc, temp);\n               addstring(n_npc, \"1\");\n            }\n         }\n      }\n      else if ((u.type == UNIT_ST_OBJ) and (bObj))\n      {\n         if (u == looker.outside)\n         {\n            u := u.next;\n            continue;\n         }\n\n         /*  if (u.outside!=looker.outside)\n         {u := u.next;\n            continue;\n         }*/\n\n         if (visible(looker, u))\n         {\n            if (isset(u.flags, UNIT_FL_TRANS) and (not isset(u.openflags, EX_CLOSED))) // MS2020\n               tpbuff := carried_by(looker, u);\n\n            temp := u.outside_descr;\n\n            if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n               temp := temp + \" (wizinv)\";\n\n            if ((isset(u.charflags, CHAR_HIDE)) and (looker.level >= IMMORTAL_LEVEL))\n               temp := temp + \" (hidden)\";\n\n            if (length(tpbuff))\n            {\n               tpbuff := sact(\" $2n carries:<br/>\" + tpbuff, A_SOMEONE, looker, u, null, TO_CHAR);\n               temp := temp + tpbuff;\n            }  \n\n            temp_in:=temp in obj;\n\n            if (temp_in > 0)\n            {\n               i := atoi(n_obj.[temp_in - 1]) + 1;\n               n_obj.[temp_in - 1] := itoa(i);\n            }\n            else\n            {\n               addstring (obj, temp);\n               addstring( n_obj,\"1\");\n            }\n         }\n      }\n      else if ((u.type == UNIT_ST_ROOM) and (bRoom))\n      {\n         if (visible(looker, u))\n         {\n            if (isset(u.flags, UNIT_FL_TRANS) and (not isset(u.openflags, EX_CLOSED)))\n               tpbuff := carried_by(looker, u);\n\n            if (length(u.outside_descr) > 0)\n            {\n               temp := \"<div class='room_descr'>\" + u.outside_descr;\n               if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n                  temp := temp + \" (wizinv)\";\n               temp := temp + \"</div>\";\n            }\n\n            if (length(tpbuff))\n            {\n               tpbuff := sact(\" $2e holds:<br/>\" + tpbuff, A_SOMEONE, looker, u, null, TO_CHAR);\n               temp := temp + tpbuff;\n            }  \n\n            if (length(temp) > 0)\n               buff := buff + temp + \"<br/>\";\n         }\n      }\n      //Well this really shouldn't happen....\n      //else\n      //   log(\"unknown unit.type in room_content for look\");\n\n      tpbuff := \"\";\n      temp := \"\";\n      u := u.next;\n   }\n\n   u := looker.outside;\n   if ((u.type == UNIT_ST_ROOM) and isset(u.flags, UNIT_FL_TRANS) and (not isset(u.openflags, EX_CLOSED)))\n   {\n      u := u.outside;\n\n      if (u)\n      {\n         tpbuff := carried_by(looker, u);\n\n         temp := sact(\"<div class='room_descr'>Outside $3n you see $2n.\", A_SOMEONE, looker, u, looker.outside, TO_CHAR);\n         if ((u.minv > 0) and (looker.level >= IMMORTAL_LEVEL))\n            temp := temp + \" (wizinv)\";\n         temp := temp + \"</div>\";\n\n         if (length(tpbuff))\n         {\n            tpbuff := sact(\" $2e holds:<br/>\" + tpbuff, A_SOMEONE, looker, u, null, TO_CHAR);\n            temp := temp + tpbuff;\n         }\n\n         if (length(temp) > 0)\n            buff := buff + temp + \"<br/>\";\n      }\n   }\n\n   iobj:= length(obj);\n   ipc := length(pc);\n   inpc:= length(npc);\n   snpc :=\"\";\n   spc  :=\"\";\n   sobj :=\"\";\n   i:=0;\n\n   while ((i<iobj) or (i<inpc) or (i<ipc))\n\t{\n      if (i<iobj)\n      {\n         if (atoi(n_obj.[i])>1)\n            sobj:=sobj+\"<div class='obj_title'>\"+\"[x\"+n_obj.[i]+\"] \"+obj.[i]+\"</div><br/>\";\n         else\n            sobj:=sobj+\"<div class='obj_title'>\"+obj.[i]+\"</div><br/>\";\n      }\n      if (i<inpc)\n      {\n         if (atoi(n_npc.[i])>1)\n            snpc:=snpc+\"<div class='npc_title'>\"+\"[x\"+n_npc.[i]+\"] \"+npc.[i]+\"</div><br/>\";\n         else\n            snpc:=snpc+\"<div class='npc_title'>\"+npc.[i]+\"</div><br/>\";\n      }\n\n      if (i<ipc)\n         spc:=spc+pc.[i]; // spc:=spc+pc.[i]+\"<br/>\";\n\n \n      i:=i+1;\n\t}\n\tbuff:=buff+\"\"+sobj+\"\"+snpc+\"\"+spc;\n   return(buff);\n} dilend"
}