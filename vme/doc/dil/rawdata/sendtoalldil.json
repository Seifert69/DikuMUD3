{
    "keyword": "sendtoalldil",
    "opcode": "DILSI_SNTADIL",
    "yacc_rule": "| DILSI_SNTADIL '(' coreexp ',' coreexp ')' ihold\n{\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'sendtoalldil' not a string\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 2 of 'sendtoalldil' not a string\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $7 + 1;\n        wtmp = &tmpl.core[$7];\n        bwrite_ubit8(&wtmp, DILI_SNTADIL);\n    }\n}",
    "dilfe_name": "dilfi_sntadil",
    "c_implementation": "void dilfi_sntadil(dilprg *p)\n{\n    /* Send message to DIL programs in all units of type specified */\n    /* sendtoall (string<message>, string<template> ) */\n\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    p->waitcmd--;\n\n    if (dil_type_check(\"sendtoalldil\", p, 2, v1, TYPEFAIL_NULL, 1, DILV_SP, v2, TYPEFAIL_NULL, 1, DILV_SP))\n    {\n        if (v1->val.ptr && !str_is_empty((char *)v2->val.ptr))\n        {\n            diltemplate *tmpl = nullptr;\n\n            tmpl = find_dil_template((const char *)v2->val.ptr);\n\n            if (tmpl)\n            {\n                dilprg *tp = nullptr;\n                if (tmpl->nextdude)\n                {\n                    slog(LOG_ALL, 0, \"INVESTIGATE: DIL sendtoall() we appear to have a nested sendtoall() with nextdude.\");\n                }\n\n                for (tp = tmpl->prg_list; tp; tp = tmpl->nextdude)\n                {\n                    tmpl->nextdude = tp->next;\n\n                    if (tp->fp && tp->fp->tmpl == tmpl && tp != p)\n                    {\n                        unit_fptr *fptr = nullptr;\n\n                        /* If it is destructed, then it cant be found because data\n                           will be null */\n\n                        for (fptr = tp->owner->getFunctionPointer(); fptr; fptr = fptr->getNext())\n                        {\n                            if (fptr->getFunctionPointerIndex() == SFUN_DIL_INTERNAL && fptr->getData() &&\n                                ((dilprg *)fptr->getData())->fp && ((dilprg *)fptr->getData())->fp->tmpl == tmpl)\n                            {\n                                break;\n                            }\n                        }\n\n                        if (!fptr)\n                        {\n                            continue;\n                        }\n\n                        spec_arg sarg;\n\n                        sarg.owner = tp->owner;\n                        sarg.activator = p->owner;\n                        sarg.medium = p->owner;\n                        sarg.target = tp->owner;\n                        sarg.pInt = nullptr;\n                        sarg.fptr = fptr;\n\n                        sarg.cmd = &g_cmd_auto_msg;\n                        sarg.arg = (char *)v1->val.ptr;\n                        sarg.mflags = SFB_MSG;\n\n                        function_activate(tp->owner, &sarg);\n                    }\n                } /* for */\n                tmpl->nextdude = nullptr;\n                dil_test_secure(p);\n            }\n        }\n    }\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin gcrps(arg:string);\ncode\n{\n    heartbeat:=3;\n    if (self.level < 200)\n    {\n        act(\"Arglebargle, glop-glyf!?!\", A_ALWAYS, self, null, null, TO_CHAR);\n        quit;\n    }\n\n    act(\"The following corpses were found:\", A_ALWAYS,self,null,null,TO_CHAR);\n    sendtoalldil(\"reportgod\",\"report_corpse@death\");\n    quit;\n} dilend"
}