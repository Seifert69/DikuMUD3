{
    "keyword": "exec",
    "opcode": "DILSI_EXE",
    "yacc_rule": "| DILSI_EXE '(' coreexp ',' coreexp ')' ihold\n{\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'exec' not a string\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 2 of 'exec' not a unit\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $7 + 1;\n        wtmp = &tmpl.core[$7];\n        bwrite_ubit8(&wtmp, DILI_EXE);\n    }\n}",
    "dilfe_name": "dilfi_exec",
    "c_implementation": "void dilfi_exec(dilprg *p)\n{\n    static int nested = 0; // Used to count nests of exec() from DIL, need for secure hack\n\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    p->waitcmd--;\n\n    if (dil_type_check(\"exec\", p, 2, v1, TYPEFAIL_NULL, 1, DILV_SP, v2, TYPEFAIL_NULL, 1, DILV_UP))\n    {\n        if (v1->val.ptr && v2->val.ptr && ((unit_data *)v2->val.ptr)->isChar())\n        {\n            char cmd[MAX_INPUT_LENGTH + 1];\n\n            strncpy(cmd, (char *)v1->val.ptr, MAX_INPUT_LENGTH);\n            cmd[MAX_INPUT_LENGTH] = 0;\n\n            if (strlen((char *)v1->val.ptr) > MAX_INPUT_LENGTH)\n            {\n                slog(LOG_ALL, 0, \"DIL %s issued command which was too long: %s\", p->sarg->owner->getFileIndexSymName(), cmd);\n            }\n\n            bool bOkToExecute = true;\n\n            if (IS_IMMORTAL((unit_data *)v2->val.ptr))\n            {\n                char buf[MAX_INPUT_LENGTH];\n                command_info *cmd_ptr = nullptr;\n\n                str_next_word(cmd, buf);\n\n                if ((cmd_ptr = (command_info *)search_trie(buf, g_intr_trie)))\n                {\n                    if (cmd_ptr->minimum_level >= IMMORTAL_LEVEL)\n                    {\n                        bOkToExecute = false;\n                        slog(LOG_EXTENSIVE,\n                             0,\n                             \"DIL %s on %s tried \"\n                             \"to make %s do: %s\",\n                             p->fp->tmpl->prgname,\n                             STR(p->sarg->owner->getNames().Name()),\n                             ((unit_data *)v2->val.ptr)->getNames().Name(),\n                             cmd);\n                    }\n                }\n            }\n\n            if (bOkToExecute)\n            {\n                nested++;\n\n                command_interpreter((unit_data *)v2->val.ptr, cmd);\n                if (p && p->frame)\n                {\n                    dil_test_secure_unit_destroyed(p, (unit_data *)v2->val.ptr);\n                }\n\n                nested--;\n            }\n        }\n    }\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin cuff_target(deputy : unitptr, targ : unitptr, cuffs : unitptr);\nvar\n   depname: string;\n\ncode\n{\n   act(\"You cuff $3n.\", A_SOMEONE, deputy, null, targ, TO_CHAR);\n   act(\"$1n surprises you and put $2n around your wrists.\", A_SOMEONE, deputy, cuffs, targ, TO_VICT);\n   act(\"$1n puts $2n around $3N's wrists.\", A_SOMEONE, deputy, cuffs, targ, TO_NOTVICT);\n\n   follow(targ, deputy);\n   depname := deputy.name;\n   link(cuffs, targ);\n   unequip(equipment(targ, WEAR_WRIST_R));\n   addequip(cuffs, WEAR_WRIST_R);\n   dilcopy(\"cuffed@midgaard(\"+depname+\")\", targ);\n   dilcopy(\"cuffed2@midgaard(\"+depname+\")\", targ);\n\n   exec(\"sigh\", targ); /* Do this to activate the DILs */\n   return;\n} dilend"
}