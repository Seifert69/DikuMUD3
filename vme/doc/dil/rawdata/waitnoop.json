{
    "keyword": "waitnoop",
    "opcode": "DILSI_WAITNOOP",
    "yacc_rule": "| DILSI_WAITNOOP ihold ahold\n{\n    $$.fst = $2;\n    $$.lst = $3 + 4;\n    wtmp = &tmpl.core[$2];\n    bwrite_ubit8(&wtmp, DILI_WAITNOOP);\n\n    wtmp = &tmpl.core[$3];\n    bwrite_ubit32(&wtmp, $2);\n}\n\n------\n\n| DILSI_WAITNOOP '(' coreexp ')' ihold ahold\n{\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'waitnoop' not a string\");\n    }\n    else\n    {\n        $$.fst = $3.fst;\n        $$.lst = $6 + 4;\n        wtmp = &tmpl.core[$5];\n        bwrite_ubit8(&wtmp, DILI_WAITNOOP);\n        wtmp = &tmpl.core[$6];\n        bwrite_ubit32(&wtmp, $3.fst);\n    }\n}",
    "dilfe_name": "dilfi_waitnoop",
    "c_implementation": "void dilfi_waitnoop(dilprg *p)\n{\n    ubit32 coreptr = 0;\n    ubit8 *oldpc = nullptr;\n    coreptr = bread_ubit32(&(p->fp->pc));\n    oldpc = &(p->fp->tmpl->core[coreptr]);\n\n    if (p->waitcmd != WAITCMD_MAXINST)\n    {\n        p->sarg->fptr->setAllActivateOnEventFlags(SFB_NOOP);\n        p->waitcmd = WAITCMD_NOOP;\n        p->fp->pc = oldpc; /* rewind pc to just before wait command */\n    }\n    else\n    {\n        // Program was waiting\n        p->waitcmd--;\n    }\n}",
    "dil_example": "dilbegin unique fnpri(FN_PRI_MISSION) dilfollow();\nvar\n   s : string;\n   c : string;\ncode\n{\n   if (not self.master)\n      quit;\n\n   act(\"You now follow $3n.\", A_ALWAYS, self, null, self.master, TO_CHAR);\n   heartbeat := 1;\n\n:start:\n   wait(SFB_DONE, TRUE);\n\n   if (not self.master)\n      quit;\n\n   if (self.master != activator)\n      goto start;\n\n   if (not visible(self, self.master))\n      goto start;\n\n   if (self.position < POSITION_STANDING)\n   {\n      if (self.position <= POSITION_SLEEPING)\n         goto start;\n      act(\"You're not in a position to follow $2n.\", A_HIDEINV, self, self.master, null, TO_CHAR);\n      goto start;\n   }\n\n   if (self.outside == self.master.outside)\n   {\n      // If you and the master are in the same object, then don't follow (sail & ride)\n      if (self.outside.type != UNIT_ST_ROOM)\n         if (not (command(\"exit\") or command(\"leave\"))) // Ignore unless leaving / exiting the object\n            goto start;\n   }\n\n   if (command(\"north\") or command(\"east\") or command(\"south\") or command(\"west\") or command(\"up\") or command(\"down\"))\n   {\n      act(\"You follow $3n $2t.\", A_HIDEINV, self, cmdstr, self.master, TO_CHAR);\n      c := cmdstr;\n      waitnoop; // The waitnoops causes loss of secure() on followers... \n      exec(c, self);\n   }\n   else if (command(\"southeast\") or command(\"northeast\") or command(\"southwest\") or command(\"northwest\"))\n   {\n      act(\"You follow $3n $2t.\", A_HIDEINV, self, cmdstr, self.master, TO_CHAR);\n      c := cmdstr;\n      waitnoop;\n      exec(c, self);\n   }\n   else if (command(\"leave\"))\n   {\n      act(\"You follow $3n.\", A_HIDEINV, self, null, self.master, TO_CHAR);\n      s := argument;\n      if (s == null)\n         s := \"\";\n      waitnoop;\n      exec(\"leave \"+s, self);\n   }\n   else if (command(\"exit\"))\n   {\n      act(\"You follow $3n.\", A_HIDEINV, self, null, self.master, TO_CHAR);\n      s := argument;\n      if (s == null)\n         s := \"\";\n      waitnoop;\n      exec(\"exit \"+s, self);\n   }\n   else if (command(\"enter\"))\n   {\n      act(\"You follow $3n.\", A_HIDEINV, self, null, self.master, TO_CHAR);\n      s := argument;\n      if (s == null)\n         s := \"\";\n      waitnoop;\n      exec(\"enter \"+s, self);\n   }\n   // Swim?\n   // Ride?\n   // Drive?\n\n   goto start;\n} dilend"
}