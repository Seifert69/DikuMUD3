{
    "keyword": "isaff",
    "opcode": "DILSE_ISA",
    "yacc_rule": "| DILSE_ISA '(' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n    $$.boolean = 1;\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'isaff' not a unit\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 2 of 'isaff' not integer\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n        make_code(&($3));\n        make_code(&($5));\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_ubit8(&($$), DILE_ISA);\n    }\n    FREEEXP($3);\n    FREEEXP($5);\n}",
    "dilfe_name": "dilfe_isa",
    "c_implementation": "void dilfe_isa(dilprg *p)\n{\n    dilval *v = new dilval;\n    /* Test if unit is affected by affect */\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_INT;\n    switch (dil_getval(v1))\n    {\n        case DILV_UP:\n            if (v1->val.ptr)\n            {\n                switch (dil_getval(v2))\n                {\n                    case DILV_INT:\n                        v->atyp = DILA_NONE;\n                        v->val.num = (affected_by_spell((unit_data *)v1->val.ptr, v2->val.num) != nullptr);\n                        break;\n                    case DILV_FAIL:\n                        v->type = DILV_FAIL;\n                        break;\n                    default:\n                        v->type = DILV_ERR; /* wrong type */\n                        break;\n                }\n            }\n            else\n            {\n                v->type = DILV_FAIL;\n            }\n            break;\n        case DILV_NULL:\n        case DILV_FAIL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR; /* wrong type */\n            break;\n    }\n\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin fido();\nvar\n  i : unitptr;\n\ncode\n{\n   on_activation(self.position <= POSITION_SLEEPING, skip);\n\n   heartbeat := PULSE_SEC*15;\n\n   :loop:\n   pause;\n\n   foreach (UNIT_ST_PC | UNIT_ST_NPC | UNIT_ST_OBJ, i)\n   {\n      if (i != self)\n      {\n         if (i.type == UNIT_ST_OBJ)\n         {\n            if ((i.objecttype == ITEM_CONTAINER) and isaff(i, ID_CORPSE))\n            {\n               act(\"$1n savagely devour $2n.\",\n               A_SOMEONE, self, i, null, TO_ROOM);\n\n               while (i.inside)\n               link(i.inside, i.outside);\n\n               destroy(i);\n               goto loop;\n            }\n         }\n         else if (rnd(0,1000) == 0)  /* Make it RARE */\n         {\n            on rnd(1,3) goto c1, c2, c3;\n\n            :c1:\n            exec(\"fart\", self);\n            goto loop;\n\n            :c2:\n            exec(\"drool\", self);\n            goto loop;\n\n            :c3:\n            act(\"$1n wets on $3n.\",\n            A_SOMEONE, self, null, i, TO_NOTVICT);\n            act(\"$1n wets on you! Eeewww!\",\n            A_SOMEONE, self, null, i, TO_VICT);\n            goto loop;\n         }\n      }\n   }\n} dilend"
}