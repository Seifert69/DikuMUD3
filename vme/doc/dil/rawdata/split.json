{
    "keyword": "split",
    "opcode": "DILSE_SPLIT",
    "yacc_rule": "| DILSE_SPLIT '(' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'split' not string\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 2 of 'split' not string\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_SLP;\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_ubit8(&($$), DILE_SPLIT);\n    }\n    FREEEXP($3);\n    FREEEXP($5);\n}",
    "dilfe_name": "dilfe_split",
    "c_implementation": "void dilfe_split(dilprg *p)\n{\n    dilval *v = new dilval;\n    /* Get first word of a string */\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n    int slen = 0;\n    char *buf = nullptr;\n    char *c = nullptr;\n    char *spbuf = nullptr;\n\n    v->type = DILV_FAIL;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_SP:\n            switch (dil_getval(v2))\n            {\n                case DILV_SP:\n                    if ((v1->val.ptr) && (v2->val.ptr))\n                    {\n                        cNamelist *words = new cNamelist;\n                        v->atyp = DILA_EXP;\n                        v->type = DILV_SLP;\n\n                        buf = (char *)malloc(strlen((char *)v1->val.ptr) + 1);\n                        spbuf = (char *)malloc(strlen((char *)v1->val.ptr) + 1);\n\n                        strcpy(buf, (char *)v1->val.ptr);\n\n                        while ((c = str_str(buf, (char *)v2->val.ptr)))\n                        {\n                            slen = strlen(buf);\n                            strncpy(spbuf, buf, slen - strlen(c) + 1);\n                            spbuf[slen - strlen(c)] = 0;\n                            words->AppendNameTrim(spbuf);\n                            spbuf[0] = 0;\n                            strcpy(spbuf, c + strlen((char *)v2->val.ptr));\n                            strcpy(buf, spbuf);\n                            spbuf[0] = 0;\n                        }\n\n                        if (buf)\n                        {\n                            words->AppendNameTrim(buf);\n                        }\n\n                        v->val.ptr = words;\n                        break;\n                    }\n                    else\n                    {\n                        v->type = DILV_FAIL;\n                    }\n                    break;\n                case DILV_FAIL:\n                case DILV_NULL:\n                    v->type = DILV_FAIL;\n                    break;\n                default:\n                    v->type = DILV_ERR;\n                    break;\n            }\n\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n\n    if (buf)\n    {\n        FREE(buf);\n        buf = nullptr;\n    }\n    if (spbuf)\n    {\n        FREE(spbuf);\n        spbuf = nullptr;\n    }\n\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin deengrave();\nexternal\n   integer IsInGuild@guilds(pc : unitptr, sGuild : string);\nvar\n    pc     : unitptr;\n \tting   : unitptr;\n \tpris   : integer;\n \ti      : integer;\n \ttext   : string;\n \tolddescr   : extraptr;\n\tcash   : string;\n\tengrv   : string;\n        engrvstr   :  stringlist;\n        newtitle   :  stringlist;\n        newdescr   :  stringlist;\ncode\n{\n    heartbeat := PULSE_SEC*4;\n\n:start:\n    wait(SFB_DONE,command(\"give\")and(self == target));\n    if(not visible(self,medium))goto start;\n    if(not visible(self,activator))\n    {\n        exec(\"sigh\",self);\n        exec(\"say How can I deal with someone I can't see?\", self );\n        exec(\"drop\"+medium.name,self);\n        goto start;\n    }\n    pc := activator;\n    ting := medium;\n    secure(pc,nopc);\n    secure(ting,ingenting);\n    dilcopy(\"busy@function(Please wait; I am working right now.)\",self);\n\n    if((ting.type != UNIT_ST_OBJ)or(ting.objecttype == ITEM_LIGHT)\n        or(ting.objecttype == ITEM_SCROLL)or(ting.objecttype == ITEM_FOOD)\n        or(ting.objecttype == ITEM_BOOK)or(ting.objecttype == ITEM_SPELL)\n        or(MAT_CLOTH_STR in ting.extra)or(MAT_FIRE_STR in ting.extra)or\n        ((ting.objecttype == ITEM_ARMOR)and(ting.value[0]==0)))\n    {\n        exec(\"say Sorry, it is beyond my ability to remove the engraving from this.\",self);\n:giveback:\n        unsecure(ting);\n        link(ting, pc);\n        act(\"$3n gives $2n to $1n.\",A_SOMEONE,pc,ting,self,TO_REST);\n        act(\"$3n gives $2n to you.\",A_SOMEONE,pc,ting,self,TO_CHAR);\n        i:=dildestroy(\"busy@function\",self);\n        unsecure (pc);\n        goto start;\n    }\n\n    if(not(\"engraving\" in ting.extra))\n    {\n        exec(\"say Hmm... this item doesn't have an engraving, \"+pc.name+\n        \".\",self);\n        goto giveback;\n    }\n\n    pause;\n    if (IsInGuild@guilds(pc, GUILD_UDG_THIEF)){ // thieves guild discount\n    \texec(\"wink \" + pc.name,self);\n    \tpris := (5*SILVER_MULT)+((ting.rent)*3);\n    }else{\n    \tpris := (5*PLATINUM_MULT)+((ting.rent)*3);\n    }\n    cash := moneystring(pris,TRUE);\n    exec(\"say Removing this engraving will cost you \"+cash+\".\",self);\n    pause;\n    if(not transfermoney(pc,self,pris))\n    {\n        exec(\"say ...which you don't have apparently.\",self);\n        exec(\"say Come back when you are richer, \"+pc.name+\".\",self);\n        goto giveback;\n    }\n    engrvstr := split(ting.extra.[\"engraving\"].descr, \"It says \");\n    newtitle := split(ting.title, \" (engraved: \" + engrvstr.[1] + \")\");\n\n    if (length(newtitle) == 2){\n\t    ting.title := newtitle.[0] + newtitle.[1];\n    }\n    else{\n    \t    ting.title := newtitle.[0];\n    }\n    subextra(ting.extra, \"engraving\");\n    olddescr := \"\" in ting.extra;\n    engrv := \"<br/>\" + engrvstr.[1] + \" is engraved on it.\";\n    newdescr := split(olddescr.descr, engrv);\n    if (length(newdescr) == 2){\n\t    olddescr.descr := newdescr.[0] + newdescr.[1];\n    }\n    else{\n    \t    olddescr.descr := newdescr.[0];\n    }\n\n    exec(\"say There, hope you like it, \" + pc.name + \"!\", self);\n    destroy(self.inside);\n    goto giveback;\n\n\n:nopc:\n    exec(\"shrug \",self);\n    exec(\"drop \"+ting.name,self);\n    i:=dildestroy(\"busy@function\",self);\n    unsecure(pc);\n    unsecure(ting);\n    goto start;\n\n:ingenting:\n    exec(\"say Huh? Where did that ting go?\",self);\n    I:=dildestroy(\"busy@function\",self);\n    unsecure(ting);\n    unsecure(pc);\n    goto start;\n\n} dilend"
}