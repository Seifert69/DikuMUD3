{
    "keyword": "idx",
    "opcode": "DILSF_IDX",
    "yacc_rule": "| DILSF_IDX /* .idx */\n{\n    INITEXP($$);\n    $$.rtyp = DilVarType_e::DILV_UP;\n    $$.typ = DilVarType_e::DILV_INT;\n    $$.dsl = DSL_DYN;\n    $$.num = DILF_SID;\n}",
    "dilfe_name": "DILF_IDX",
    "c_implementation": "case DILF_IDX:\n            v2 = p->stack.pop();\n\n            switch (dil_getval(v1))\n            {\n                case DILV_NULL: /* not applicable */\n                case DILV_FAIL:\n                    v->type = DILV_FAIL;\n                    break;\n                case DILV_SP:\n                case DILV_SLP:\n                    if (v1->val.ptr)\n                    {\n                        v->type = DILV_SP;\n                    }\n                    else\n                    {\n                        v->type = DILV_FAIL; /* NULL list */\n                    }\n                    break;\n                case DILV_ILP:\n                    if (v1->val.ptr)\n                    {\n                        v->type = DILV_INT;\n                    }\n                    else\n                    {\n                        v->type = DILV_FAIL; /* NULL list */\n                    }\n                    break;\n                case DILV_EDP:\n                    if (v1->val.ptr)\n                    {\n                        v->type = DILV_EDP;\n                    }\n                    else\n                    {\n                        v->type = DILV_FAIL;\n                    }\n                    break;\n                default:\n                    v->type = DILV_ERR; /* wrong type */\n                    break;\n            }\n\n            switch (dil_getval(v2))\n            {\n                case DILV_FAIL:\n                    if (v->type != DILV_ERR)\n                    {\n                        v->type = DILV_FAIL; /* not applicable */\n                    }\n                    break;\n                case DILV_INT:\n                case DILV_SP:\n                    break;\n                default:\n                    v->type = DILV_ERR; /* wrong type */\n            }\n\n            if (v->type == DILV_INT)\n            {\n                if (((sbit32)v2->val.num < ((cintlist *)v1->val.ptr)->Length()) && (v2->val.num >= 0))\n                {\n                    v->atyp = DILA_NONE; // Dont dealloc!\n                    v->type = DILV_SINT4R;\n                    v->ref = (((cintlist *)v1->val.ptr)->ValuePtr(v2->val.num));\n                }\n                else\n                {\n                    v->type = DILV_FAIL; /* illegal index */\n                }\n            }\n            else if (v->type == DILV_EDP)\n            {\n                v->atyp = DILA_NORM;\n                v->type = DILV_EDP;\n                if (v1->val.ptr)\n                {\n                    v->val.ptr = ((extra_descr_data *)v1->val.ptr)->find_raw(skip_spaces((char *)v2->val.ptr));\n                }\n                else\n                {\n                    v->val.ptr = nullptr;\n                }\n            }\n            else if (v->type == DILV_SP)\n            {\n                if (dil_getval(v1) == DILV_SP)\n                {\n                    if ((v2->val.num >= 0) && (v2->val.num < (int)strlen((char *)v1->val.ptr)))\n                    {\n                        v->atyp = DILA_EXP;\n                        v->type = DILV_SP;\n                        v->val.ptr = (char *)malloc(2);\n                        ((char *)v->val.ptr)[0] = ((char *)v1->val.ptr)[v2->val.num];\n                        ((char *)v->val.ptr)[1] = 0;\n                    }\n                    else\n                    {\n                        szonelog(p->sarg->owner->getFileIndex()->getZone(),\n                                 \"DIL %s %s@%s, index of stringlist out of bounds: %d\\n\",\n                                 p->sarg->owner->getFileIndexSymName(),\n                                 p->fp->tmpl->prgname,\n                                 p->fp->tmpl->zone->getName(),\n                                 v2->val.num);\n\n                        v->type = DILV_FAIL;\n                    }\n                }\n                else\n                {\n                    v->atyp = DILA_EXP;\n\n                    if (((ubit32)v2->val.num < ((cNamelist *)v1->val.ptr)->Length()) && (v2->val.num >= 0))\n                    {\n                        v->atyp = DILA_NONE; // Dont dealloc!\n                        v->type = DILV_HASHSTR;\n                        v->ref = ((cNamelist *)v1->val.ptr)->InstanceName(v2->val.num);\n                    }\n                    else\n                    {\n                        szonelog(p->sarg->owner->getFileIndex()->getZone(),\n                                 \"DIL %s %s@%s, index of stringlist out of bounds: %d\\n\",\n                                 p->sarg->owner->getFileIndexSymName(),\n                                 p->fp->tmpl->prgname,\n                                 p->fp->tmpl->zone->getName(),\n                                 v2->val.num);\n                        v->type = DILV_FAIL; /* illegal index */\n                    }\n                }\n            }\n            else\n            {\n                v->type = DILV_FAIL; /* illegal index */\n            }\n            break;",
    "dil_example": "dilbegin fnpri(FN_PRI_RESCUE-1) jailstay(du : integer);\nexternal\n   integer add_reward@justice(criminal_symname : string, criminal_idx : integer, crime_type : integer);\n   rem_db_entry@justice(criminal : unitptr, extra_type : string, juris : string);\n   getfrom_safe(prisoner : unitptr);\n   set_char_flags@justice(char : unitptr, setting : string);\nvar\n   sname : string;\n   jd : unitptr;\n   id : string;\n   juris : string; \n   k : string;\n   gold : integer;\n   g : string;\ncode\n{\n   heartbeat := PULSE_SEC * SECS_PER_MUD_HOUR;\n   juris := self.outside.zoneidx;\n   sname := self.outside.symname; // Get the jail symname\n\n   jd := findsymbolic(\"database@justice\");\n   id := \"$reward \"+ self.symname + \" \" + itoa(self.idx) + \" \"+ juris;\n   k := \"$reward \"+ juris;\n     \n   // Change player arrest descr to reflect that the char is in jail.\n   //\n   jd := findsymbolic(\"database@justice\");\n   \n   if( \"$reward\" in self.extra)\n   {\n      jd.extra.[id].names.[4] := \"-1\";\n      self.extra.[k].names.[4] := \"-1\";\n      jd.extra.[id].descr := self.name+\" is currently serving time in jail.\";\n   }\n\n \n  :loop:\n   pause;\n   if (sname != self.outside.symname)\n   {\n      // Player has escaped from jail\n      jd := findsymbolic(\"database@justice\");\n      jd.extra.[id].names.[4] := \"65\";\n      self.extra.[k].names.[4] := \"65\";\n      gold := atoi(jd.extra.[id].names.[2]); \n      g := moneystring(gold,1); \n      jd.extra.[id].descr := \"A reward of \" + g + \" has been offered for the head of \"+self.name;\n      set_char_flags@justice(self, \"wanted\");\n      log(\"Jailbreak: \"+self.name+\" has escaped from the \"+ juris +\" jail.\"); \n      quit;\n   }\n\n   if(\"$reward\" in self.extra)\n   {\n      jd := findsymbolic(\"database@justice\");\n      jd.extra.[id].names.[4] := \"-1\";\n      jd.extra.[id].descr := self.name+\" is currently serving time in jail. \"+itoa(du)+\" hours remaining\";\n   }\n\n   if ((du % 4) == 0)\n     send(\"jailfood\");\n\n   if (du == 24)\n   {\n      act(\"At last! The very last day of your term!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n   }\n   else if (du == 12)\n   {\n      act(\"Only half a day left 'till your freedom!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n   }\n   else if (du <= 1)\n     goto release;\n   else\n   {\n      act(\"You make another mark on the wall. Only \"+itoa(du)+\" hours till freedom!\",\n          A_ALWAYS, self, null, null, TO_CHAR);\n   }\n   \n   du := du - 1;\n   goto loop;\n\n\n   /* Get thrown out of jail */\n   :release:\n   act(\"Your term is over! You are thrown out of the jail and sent home.\",\n       A_ALWAYS, self, null, null, TO_CHAR);\n   getfrom_safe(self);\n   link(self, findroom(\"accuse_room@\" + juris));\n   rem_db_entry@justice(self, \"$reward\", juris);\n   set_char_flags@justice(self, \"arrest\");\n   quit;\n} dilend"
}