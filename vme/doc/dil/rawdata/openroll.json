{
    "keyword": "openroll",
    "opcode": "DILSE_OPRO",
    "yacc_rule": "| DILSE_OPRO '(' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n\n    if ($3.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 1 of 'openroll' not an integer\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_INT)\n    {\n        dilfatal(\"Arg 2 of 'openroll' not an integer\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n\n        make_code(&($3));\n        make_code(&($5));\n\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_ubit8(&($$), DILE_OPRO);\n    }\n\n    FREEEXP($3);\n    FREEEXP($5);\n}",
    "dilfe_name": "dilfe_opro",
    "c_implementation": "void dilfe_opro(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_INT;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_INT:\n            switch (dil_getval(v2))\n            {\n                case DILV_INT:\n                    if ((v1->val.num > 0) && (v2->val.num > 0) && (v2->val.num < v1->val.num / 2 - 1))\n                    {\n                        v->val.num = open_ended_roll(v1->val.num, v2->val.num);\n                    }\n                    else\n                    {\n                        v->val.num = 0;\n                    }\n                    break;\n                default:\n                    v->type = DILV_ERR;\n                    break;\n            }\n\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin healing_balm();\nvar\n u : unitptr;\n pc : unitptr;\n txt : string;\ncode\n{\n        :start:\nwait(SFB_CMD,(command(\"aid\")or command(\"quaff\"))and\n(self.equip==WEAR_HOLD)\nand(activator==self.outside)and(activator.position>POSITION_SLEEPING));\nblock;\npc:=activator;\ntxt:=argument;\n\nif (command(\"quaff\"))\n{\nsendtext(\"No idea in quaffing the balm, it's for external use only.<br/>\",pc);\ngoto start;\n}\n\nif ((pc.position==POSITION_SITTING)or(pc.position==POSITION_RESTING))\n{\nsendtext(\"Nah... you're too relaxed to think about that right now...<br/>\",pc);\ngoto start;\n}\n\nif (txt==\"\")\n{\nsendtext(\"Aid who?<br/>\",pc);\ngoto start;\n}\n\nu:=findunit(self.outside,txt,FIND_UNIT_SURRO,null);\n\nif ((u.type==UNIT_ST_PC)or(u.type==UNIT_ST_NPC))\n{\nif (u==pc)\n  {\n  sendtext(\"What point would there be in applying the balm to yourself?<br/>\"+\n  \"You are not dying at the moment!<br/>\",pc);\n  goto start;\n  }\nif ((u.hp>0)and(u.position>POSITION_INCAP))\n  {\n  sendtext(\"But \"+u.name+\" is not dying at the moment!<br/>\",pc);\n  goto start;\n  }\nif ((u.type==UNIT_ST_NPC)and(u.race>999))\n {\n sendtext(\"You don't recognize the anatomy of this creature, you can't \"+\n \"apply the balm!<br/>\",pc);\n goto start;\n }\n\n sendtext(\"You carefully apply the healing balm to \"+u.name+\"'s bleeding \"+\n \"wounds...<br/>\",pc);\n act(\"$1n carefully applies some $2N to $3n's bleeding wounds...\",\n A_SOMEONE,pc,self,u,TO_NOTVICT);\n if (openroll(60,5)<pc.skills[SKI_FIRST_AID])\n {\n u.hp:=1;\n u.position:=POSITION_RESTING;\n position_update(u);\n act(\"The wounds on $3n's body close up, and a sigh comes from $3s chest.\",\n A_SOMEONE,pc,self,u,TO_NOTVICT);\n act(\"The wounds on $3n's body close up, and a sigh comes from $3s chest.\",\n A_SOMEONE,pc,self,u,TO_CHAR);\n sendtext(\"You awake from the coma, feeling weak yet still alive!<br/>\",u);\n destroy(self);\n }\n else\n {\n sendtext(\"Oh no! You must have made some error in your treatment!<br/>\",pc);\n act(\"There is no apparent effect to be seen.\",A_SOMEONE,pc,self,u,TO_ALL);\n destroy(self);\n }\ngoto start;\n}\nsendtext(\"No-one here by this name.<br/>\",self.outside);\ngoto start;\n} dilend"
}