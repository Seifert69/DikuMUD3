{
    "keyword": "opponent",
    "opcode": "DILSE_OPPO",
    "yacc_rule": "| DILSE_OPPO '(' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n    $$.boolean = 1;\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'opponent' not a unitptr\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 2 of 'opponent' not a unitptr\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n        make_code(&($3));\n        make_code(&($5));\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_ubit8(&($$), DILE_OPPO);\n    }\n    FREEEXP($3);\n    FREEEXP($5);\n}",
    "dilfe_name": "dilfe_oppo",
    "c_implementation": "void dilfe_oppo(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_INT;\n    switch (dil_getval(v1))\n    {\n        case DILV_UP:\n            if (!v1->val.ptr || !((unit_data *)v1->val.ptr)->isChar())\n            {\n                v->type = DILV_FAIL;\n            }\n            else\n            {\n                switch (dil_getval(v2))\n                {\n                    case DILV_UP:\n                        if (!v2->val.ptr || !((unit_data *)v2->val.ptr)->isChar())\n                        {\n                            v->type = DILV_FAIL;\n                        }\n                        else\n                        {\n                            v->val.num = (CHAR_COMBAT((unit_data *)v1->val.ptr)\n                                              ? CHAR_COMBAT((unit_data *)v1->val.ptr)->FindOpponent((unit_data *)v2->val.ptr) != nullptr\n                                              : FALSE);\n                        }\n                        break;\n                    case DILV_FAIL:\n                    case DILV_NULL:\n                        v->type = DILV_FAIL;\n                        break;\n                    default:\n                        v->type = DILV_ERR;\n                        break;\n                }\n            }\n\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin provoked_attack(victim : unitptr, ch : unitptr);\ncode\n{\n   if (not (victim.type & (UNIT_ST_NPC|UNIT_ST_PC)))\n     return; /* FALSE */\n\n   if (not (ch.type & (UNIT_ST_PC|UNIT_ST_NPC)))\n     return; /* FALSE */\n\n   if (victim.level >= 200)\n     return; /* FALSE */\n\n   if (ch.level >= 200)\n     return; /* FALSE */\n\n   if (not isset(ch.charflags, CHAR_SELF_DEFENCE))\n   {\n      if ((ch.fighting == null) and\n\t  (not isset(victim.charflags, CHAR_LEGAL_TARGET)))\n        set(victim.charflags, CHAR_SELF_DEFENCE);\n   }\n\n   /* Test for LEGAL_TARGET bit */\n   if (isset(victim.charflags, CHAR_PROTECTED))\n   {\n       if ((not isset(victim.charflags, CHAR_LEGAL_TARGET)) and\n           (not isset(ch.charflags, CHAR_SELF_DEFENCE)))\n         set(ch.charflags, CHAR_LEGAL_TARGET);\n   }\n\n   if (victim.position <= POSITION_SLEEPING)\n     return; /* FALSE */\n\n   if (isset(victim.charflags, CHAR_PEACEFUL))\n     return; /* FALSE */\n\n   if (opponent(victim, ch))\n     return; /* TRUE */\n\n   set_fighting(victim, ch);\n\n   return; /* TRUE */\n} dilend"
}