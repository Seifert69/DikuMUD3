{
    "keyword": "spellindex",
    "opcode": "DILSE_SPLX",
    "yacc_rule": "| DILSE_SPLX '(' dilexp ')' /* spellindex */\n{\n    INITEXP($$);\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'spellindex' not a string\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n        make_code(&($3));\n        add_code(&($$), &($3));\n        add_ubit8(&($$), DILE_SPLX);\n    }\n    FREEEXP($3);\n}",
    "dilfe_name": "dilfe_splx",
    "c_implementation": "void dilfe_splx(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_INT;\n    switch (dil_getval(v1))\n    {\n        case DILV_SP:\n            if (!v1->val.ptr)\n            {\n                v->type = DILV_FAIL;\n            }\n            else\n            {\n                const char *c = (const char *)v1->val.ptr;\n                if (str_is_empty(c))\n                {\n                    v->val.num = -1;\n                }\n                else\n                {\n                    v->val.num = search_block_abbrevs(c, g_SplColl.text, &c);\n                }\n            }\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n\n    p->stack.push(v);\n    delete v1;\n}",
    "dil_example": "dilbegin do_setskill(arg : string);\n\nexternal\n   integer skillindex(s1 : string);\n   integer weaponindex(s1 : string);\n\nvar\n\n  item        :  unitptr;\n  cnt         :  integer;\n  stype       :  string;\n  sname       :  string;\n  sdef        :  integer;\n  samnt       :  integer;\n  schk        :  integer;\n  temp        :  string;\n  slist       :  stringlist;\n  scomp       :  stringlist;\n  buffer      :  string;\n  t1          :  integer;\n  t2          :  integer;\n  t3          :  integer;\n  t4          :  integer;\n  t5          :  integer;\n  t6          :  integer;\n  t7          :  integer;\n\n\ncode{\n\n\n if (arg == \"\")\n    {\n      sendtext(\"Syntax: setskill <name> (skill|spell|weapon) <field> <value>.<br/>\", self);\n      sendtext(\"For skills with spaces, use underscore, e.g. armor_soft_leather<br/>\", self);\n      quit;\n    }\n\n temp := arg;\n cnt := 1;\n\n:loop:\n\n item := findunit(self, temp, FIND_UNIT_GLOBAL, null);\n\n if ((item) and (not visible(self, item)))\n    {\n      cnt := cnt + 1;\n      temp := itoa(cnt) + \".\" + arg;\n      goto loop;\n    }\n\n if (item == null)\n    {\n      sendtext(\"No such player or mobile to setskill on.<br/>\", self);\n      quit;\n    }\n\n\n if ((item.type != UNIT_ST_PC) and (item.type != UNIT_ST_NPC))\n    {\n      sendtext(\"Setskill can only be used on PC's or NPC's.<br/>\", self);\n      quit;\n    }\n\n stype := getword(temp);\n\n if (stype == \"skill\")\n     goto set_skill;\n\n if (stype == \"spell\")\n     goto set_spell;\n\n if (stype == \"weapon\")\n     goto set_weapon;\n\n sendtext(\"Your options are either 'skill', 'spell' or 'weapon'.<br/>\", self);\n quit;\n\n\n:set_skill:\n\n  if (item.type == UNIT_ST_NPC)\n     {\n       sendtext(\"Mobiles cannot have skills set in this manner.<br/>\", self);\n       quit;\n     }\n\n  sname := getword(temp);\n\n  if (sname == \"\")\n       sdef := -1;\n  else\n     {\n       slist := split(sname, \"_\");\n\n       sname := slist.[0];\n\n       cnt := 1;\n\n       while (cnt < length(slist))\n           {\n             sname := sname + \" \" + slist.[cnt];\n             cnt := cnt + 1;\n           }\n\n\n       sdef := skillindex(sname);\n     }\n\n  if (sdef == -1)\n     {\n       buffer := \"Invalid skill, please choose from the following:<br/>\";\n\n       sdef := 0;\n       while (sdef < SKI_TREE_MAX)\n          {\n            sname := skill_name(sdef);\n\n            if (sname == \"\")\n                break;\n\n            buffer := buffer + sname + \"<br/>\";\n\n            sdef := sdef + 1;\n          }\n\n       sendtext(buffer, self);\n       quit;\n     }\n\n  temp := getword(temp);\n  samnt := atoi(temp);\n  item.skills[sdef] := samnt;\n  sname := skill_name(sdef);\n\n  act(\"$2n's skill in \" + sname + \" is set to $3t.\", A_ALWAYS, self, item, itoa(samnt), TO_CHAR);\n\n  quit;\n\n\n\n:set_weapon:\n\n  sname := getword(temp);\n\n  if (sname == \"\")\n       sdef := -1;\n  else\n     {\n       slist := split(sname, \"_\");\n\n       sname := slist.[0];\n\n       cnt := 1;\n\n       while (cnt < length(slist))\n           {\n             sname := sname + \" \" + slist.[cnt];\n             cnt := cnt + 1;\n           }\n\n\n       sdef := weaponindex(sname);\n     }\n\n  if (sdef == -1)\n     {\n       buffer := \"Invalid weapon, please choose from the following:<br/>\";\n\n       sdef := 0;\n       while (sdef < WPN_TREE_MAX)\n          {\n            sname := weapon_name(sdef);\n\n            if (sname == \"\")\n                break;\n\n            buffer := buffer + sname + \"<br/>\";\n\n            sdef := sdef + 1;\n          }\n\n       sendtext(buffer, self);\n       quit;\n     }\n\n  if ((item.type == UNIT_ST_NPC) and (sdef >= WPN_GROUP_MAX))\n     {\n       sendtext(\"Mobiles can only have weapon groups set.<br/>\", self);\n       quit;\n     }\n\n  temp := getword(temp);\n  samnt := atoi(temp);\n  item.weapons[sdef] := samnt;\n  sname := weapon_name(sdef);\n\n  act(\"$2n's skill in \" + sname + \" is set to $3t.\", A_ALWAYS, self, item, itoa(samnt), TO_CHAR);\n\n  quit;\n\n\n:set_spell:\n\n  sname := getword(temp);\n\n  if (sname == \"\")\n       sdef := -1;\n  else\n     {\n       slist := split(sname, \"_\");\n\n       sname := slist.[0];\n\n       cnt := 1;\n\n       while (cnt < length(slist))\n          {\n            sname := sname + \" \" + slist.[cnt];\n            cnt := cnt + 1;\n          }\n\n\n       sdef := spellindex(sname);\n     }\n\n  if (sdef == -1)\n     {\n       buffer := \"Invalid spell, please choose from the following:<br/>\";\n\n       sdef := 0;\n       while (sdef < SPL_TREE_MAX)\n          {\n            sname := spellinfo(sdef, t1, t2, t3, t4, t5, t6, t7);\n\n            if (sname == \"\")\n                break;\n\n            buffer := buffer + sname + \"<br/>\";\n\n            sdef := sdef + 1;\n          }\n\n       sendtext(buffer, self);\n       quit;\n     }\n\n  if ((item.type == UNIT_ST_NPC) and (sdef >= SPL_GROUP_MAX))\n     {\n       sendtext(\"Mobiles can only have spell groups set.<br/>\", self);\n       quit;\n     }\n\n  temp := getword(temp);\n  samnt := atoi(temp);\n  item.spells[sdef] := samnt;\n  sname := spellinfo(sdef, t1, t2, t3, t4, t5, t6, t7);\n\n  act(\"$2n's skill in \" + sname + \" is set to $3t.\", A_ALWAYS, self, item, itoa(samnt), TO_CHAR);\n\n  quit;\n\n\n} dilend"
}