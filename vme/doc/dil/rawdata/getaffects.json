{
    "keyword": "getaffects",
    "opcode": "DILSE_GETAFFECTS",
    "yacc_rule": "| DILSE_GETAFFECTS '(' dilexp ')'\n{\n    INITEXP($$);\n    if ($3.typ != DilVarType_e::DILV_UP)\n    {\n        dilfatal(\"Arg 1 of 'getaffcets' not unitptr\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_SLP;\n        add_code(&($$), &($3));\n        add_ubit8(&($$), DILE_GETAFFECTS);\n    }\n    FREEEXP($3);\n}",
    "dilfe_name": "dilfe_getaffects",
    "c_implementation": "void dilfe_getaffects(dilprg *p)\n{\n    dilval *v1 = p->stack.pop();\n\n    dilval *v = new dilval;\n    v->type = DILV_FAIL;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_UP:\n            if (v1->val.ptr)\n            {\n                v->atyp = DILA_EXP;\n                v->type = DILV_SLP;\n                cNamelist *words = new cNamelist;\n                get_affects((unit_data *)v1->val.ptr, words);\n                v->val.ptr = words;\n            }\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n\n    p->stack.push(v);\n    delete v1;\n}",
    "dil_example": "dilbegin string identify_str(tgt : unitptr, lvl : integer);\nexternal\n    string quality_str(i : integer);\n    string magic_str(i : integer);\n    string race_name@skills(i : integer);\n    string abistr@function(ability:integer);\nvar\n    exd : extraptr;\n    craft_str : string;\n    mag_str : string;\n    s : string;\n    s2 : string;\n    i : integer;\n    n : integer;\n    i2 : integer;\n    sl : stringlist;\n    sl2 : stringlist;\n\ncode\n{\n    if (tgt.objecttype == ITEM_LIGHT)\n    {\n        s := sact(\"$3n is light source with \"+itoa(tgt.value[0])+\" hours left, and an illumination of \"+itoa(tgt.value[1])+\".<br/>\",\n                    A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_SCROLL)\n    {\n        s := sact(\"$3n is a scroll with a magical power of \"+itoa(tgt.value[0])+\"<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n        if (lvl >= 2)\n        {\n            s2 := spellinfo(tgt.value[1], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n\n            s2 := spellinfo(tgt.value[2], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n\n            s2 := spellinfo(tgt.value[3], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n        }\n    }\n    else if (tgt.objecttype == ITEM_WAND)\n    {\n        s := sact(\"$3n is a wand with a magical power of \"+itoa(tgt.value[0])+\" and \"+itoa(tgt.value[1])+\n                    \" charges of \" + itoa(tgt.value[4]) + \" left.<br/>\",\n                    A_SOMEONE, self, null, tgt, TO_CHAR);\n        if (lvl >= 2)\n        {\n            s2 := spellinfo(tgt.value[2], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n\n            s2 := spellinfo(tgt.value[3], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n        }\n    }\n    else if (tgt.objecttype == ITEM_STAFF)\n    {\n        s := sact(\"$3n is a staff with power \"+itoa(tgt.value[0])+\" and \" + itoa(tgt.value[1])+\n                \" charges of \" + itoa(tgt.value[4]) + \" left.<br/>\",\n                A_SOMEONE, self, null, tgt, TO_CHAR);\n        if (lvl >= 2)\n        {\n            s2 := spellinfo(tgt.value[2], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n\n            s2 := spellinfo(tgt.value[3], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n        }\n    }\n    else if (tgt.objecttype == ITEM_WEAPON)\n    {\n        craft_str := quality_str(tgt.value[1]);\n        mag_str := magic_str(tgt.value[2]);\n\n        s := sact(\"$3n is a weapon that requires a \" + weapon_name(tgt.value[0]) + \" fighting style, is of \" + craft_str + \n                    \" craftsmanship \" + \" and has a \" + mag_str + \" magical modifier.<br/>\",\n                    A_SOMEONE, self, null, tgt, TO_CHAR);\n\n        if (lvl >= 2)\n        {\n            s := s + \"Craftsmanship: \" + itoa(tgt.value[1]) + \"<br/>\";\n            s := s + \"Magic: \" + itoa(tgt.value[2]) + \"<br/>\";\n            if (tgt.value[3] != RACE_DO_NOT_USE)\n                s := s + \"Slaying: \" + race_name@skills(tgt.value[3]) + \"<br/>\";  // Find race string\n        }\n    }\n    else if (tgt.objecttype == ITEM_ARMOR)\n    {\n        sl := {\"clothing\", \"soft leather\", \"hard leather\", \"chain mail\", \"plate mail\"};\n\n        craft_str := quality_str(tgt.value[1]);\n        mag_str := magic_str(tgt.value[2]);\n        s := sact(\"$3n is a \"+sl.[tgt.value[0]]+ \" equivalent armor with \"+craft_str+\" craftsmanship and has a \"+mag_str+\" magical modifier.<br/>\",\n            A_SOMEONE, self, null, tgt, TO_CHAR);\n\n        if (lvl >= 2)\n        {\n            s := s + \"Craftsmanship: \" + itoa(tgt.value[1]) + \"<br/>\";\n            s := s + \"Magic: \" + itoa(tgt.value[2]) + \"<br/>\";\n        }\n    }\n    else if (tgt.objecttype == ITEM_TREASURE)\n    {\n        s := sact(\"$3n appears to be nothing less than a treasure!<br/>\",\n                    A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_POTION)\n    {\n        s := sact(\"$3n is a potion with power \"+itoa(tgt.value[0])+\".<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n        if (lvl >= 2)\n        {\n            s2 := spellinfo(tgt.value[1], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n\n            s2 := spellinfo(tgt.value[2], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n\n            s2 := spellinfo(tgt.value[3], i, i, i,i ,i ,i ,i);\n            if (s2 != null)\n                s := s + \"Spell: \" + s2 + \"<br/>\";\n        }\n    }\n    else if (tgt.objecttype == ITEM_SHIELD)\n    {\n        craft_str := quality_str(tgt.value[1]);\n        mag_str := magic_str(tgt.value[2]);\n\n        s := sact(\"$3n is a shield with \"+craft_str+\" craftsmanship and has a \"+mag_str+\" magical modifier.<br/>\",\n            A_SOMEONE, self, null, tgt, TO_CHAR);\n\n        if (lvl >= 2)\n        {\n            s := s + \"Craftsmanship: \" + itoa(tgt.value[1]) + \"<br/>\";\n            s := s + \"Magic: \" + itoa(tgt.value[2]) + \"<br/>\";\n        }\n    }\n    else if (tgt.objecttype == ITEM_WORN)\n    {\n        s := sact(\"$3n appears to be an item designed to be worn.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_NOTE)\n    {\n        s := sact(\"$3n seems to be of literary value.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_FOOD)\n    {\n        s := sact(\"$3n is consumable.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n        if (tgt.value[3] > 0)\n            s := s + sact(\"It is poisoned.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_DRINKCON)\n    {\n        s := sact(\"$3n is a drink container.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n\n        if (tgt.value[3] > 0)\n            s := s + sact(\"It is poisoned.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_KEY)\n    {\n        s := sact(\"$3n is a key.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_MONEY)\n    {\n        s := sact(\"$3n is money.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_PEN)\n    {\n        s := sact(\"$3n is a pen.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_BOAT)\n    {\n        s := sact(\"$3n is a boat which can carry \"+itoa(tgt.capacity)+\" pounds.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else if (tgt.objecttype == ITEM_CONTAINER)\n    {\n        if (dilfind(\"rot_corpse@death\",tgt) or dilfind(\"rotting@spells\",tgt))\n            s := sact(\"It is a dead body.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n        else\n            s := sact(\"It is a container.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n    else\n    {\n        s := sact(\"You gain no additional insight into this item.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n    }\n\n    if (tgt.bright != 0)\n    {\n        if (tgt.bright > 0)\n        {\n            if (lvl >= 2)\n                s := s + sact(\"$3n emits light with an illumination of \"+itoa(tgt.bright)+\".<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n            else\n                s := s + sact(\"$3n emits light.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n        }\n        else\n        {\n            if (lvl >= 2)\n                s := s + sact(\"$3n enshrouds darkness with a dampening of \"+itoa(-tgt.bright)+\".<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n            else\n                s := s + sact(\"$3n enshrouds darkness.<br/>\", A_SOMEONE, self, null, tgt, TO_CHAR);\n        }\n    }\n\n    // Now let's parse any (transfer) affects \n    sl := getaffects(tgt);\n    n := length(sl);\n\n    if (n > 0)\n    {\n        s := s + \"----<br/>\";\n    }\n\n    i := 0;\n    while (i < n)\n    {\n        sl2 := split(sl.[i], \",\");\n        i2 := atoi(sl2.[0]);\n        if (i2 < 0)\n            i2 := -i2;\n\n        if (i2 == ID_SANCTUARY) // Sanctuary transfer\n        {\n            s := s + \"Sanctuary spell.<br/>\";\n        }\n        else if (sl2.[1] == \"0\") // Ability adjustment\n        {\n            s := s + \"Ability bonus: \";\n            i2 := atoi(sl2.[2]);\n            s := s + abistr@function(i2) + \" \"; // e.g. \"strength\"\n\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"1\") // Spell adjustment\n        {\n            s := s + \"Spell bonus: \";\n            i2 := atoi(sl2.[2]);\n            s2 := spellinfo(i2, i2, i2, i2, i2 ,i2 ,i2 ,i2);\n            s := s + s2 + \" \"; // e.g. \"fireball\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"2\") // Modify bright/light\n        {\n            s := s + \"Light bonus: \"+sl.[i];\n            i2 := atoi(sl2.[2]);\n            s := s + skill_name(i2) + \" \"; // e.g. \"fleeing\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"3\") // Modify char flags\n        {\n            s := s + \"Special ability C: \"+sl.[i];\n            i2 := atoi(sl2.[2]);\n            s := s + skill_name(i2) + \" \"; // e.g. \"fleeing\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"4\") // Modify UNIT_FLAGS()\n        {\n            s := s + \"Special ability U: \"+sl.[i];\n            i2 := atoi(sl2.[2]);\n            s := s + skill_name(i2) + \" \"; // e.g. \"fleeing\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"5\") // Modify OBJ_FLAGS()\n        {\n            s := s + \"Special ability O: \"+sl.[i];\n            i2 := atoi(sl2.[2]);\n            s := s + skill_name(i2) + \" \"; // e.g. \"fleeing\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"6\") // Modify skill adjustment\n        {\n            s := s + \"Skill bonus: \";\n            i2 := atoi(sl2.[2]);\n            s := s + skill_name(i2) + \" \"; // e.g. \"fleeing\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"7\") // Modify weapon adjustment\n        {\n            s := s + \"Weapon bonus: \";\n            i2 := atoi(sl2.[2]);\n            s := s + weapon_name(i2) + \" \"; // e.g. \"fleeing\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"8\") // Modify Natural armor\n        {\n            s := s + \"Natural armor modification: \"+sl.[i];\n            i2 := atoi(sl2.[2]);\n            s := s + skill_name(i2) + \" \"; // e.g. \"fleeing\"\n            i2 := atoi(sl2.[3]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + sl2.[3] + \"<br/>\";\n        }\n        else if (sl2.[1] == \"9\") // Modify speed\n        {\n            s := s + \"Speed bonus: \"; //+sl.[i];\n            i2 := atoi(sl2.[2]);\n            if (i2 >= 0)\n                s := s + \"+\";\n            s := s + itoa(i2) + \"<br/>\";\n        }\n        else if (sl2.[1] == \"-1\")\n        {\n            i2 := atoi(sl2.[0]);\n            if (i2 < 0)\n                i2 := -i2;\n            if (i2 == ID_PROT_GOOD)\n            {\n                s := s + \"Protection from Good<br/>\";\n            }\n            else if (i2 == ID_PROT_EVIL)\n            {\n                s := s + \"Protection from Evil<br/>\";\n            }\n            else\n            {\n                s := s + \"-1 please report to an admin. Unknown secondary kind. \" + sl.[i];\n            }\n        }\n        else if (sl2.[1] != \"-1\")\n        {\n            s := s + \"Oh no, please report to an admin. Unknown kind. \" + sl.[i];\n        }\n\n        i := i + 1;\n    }\n\n    // Finally copy in the description from $identify / $improved identify\n\n    exd := \"$identify\" in tgt.extra;\n    if (exd)\n        s := exd.descr + s;\n\n    if (lvl >= 2)\n    {\n        exd := \"$improved identify\" in tgt.extra;\n        if (exd)\n            s := exd.descr + s;\n    }\n\n    return(s);\n} dilend"
}