{
    "keyword": "loadstr",
    "opcode": "DILSE_LDSTR",
    "yacc_rule": "| DILSE_LDSTR '(' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'loadstr' not string\");\n    }\n    else if ($5.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 2 of 'loadstr' not string\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_INT;\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_ubit8(&($$), DILE_LDSTR);\n    }\n    FREEEXP($3);\n    FREEEXP($5);\n}",
    "dilfe_name": "dilfe_ldstr",
    "c_implementation": "void dilfe_ldstr(dilprg *p)\n{\n    dilval *v = new dilval;\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n    char *sstr = nullptr;\n\n    v->type = DILV_INT;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_SP:\n            switch (dil_getval(v2))\n            {\n                case DILV_SP:\n                    if (p->frame[0].tmpl->zone->getAccessLevel() > 10)\n                    {\n                        szonelog(p->frame->tmpl->zone,\n                                 \"DIL '%s' attempt to violate system access security (loadstr).\",\n                                 p->frame->tmpl->prgname);\n                        p->waitcmd = WAITCMD_QUIT;\n                    }\n                    else if (!store_name_test((char *)v1->val.ptr))\n                    {\n                        szonelog(p->frame->tmpl->zone, \"DIL '%s' attempted to loadstr n illegal file name.\", p->frame->tmpl->prgname);\n                        v->val.num = FALSE;\n                    }\n                    else\n                    {\n                        sstr = nullptr;\n                        std::filesystem::path filename{p->frame[0].tmpl->zone->getDILFilePath().value_or(g_cServerConfig.getDILFileDir())};\n                        filename += \"/strings/\";\n                        filename += (char *)v1->val.ptr;\n                        v->val.num = load_string(filename.c_str(), &sstr);\n                        if (!str_is_empty(sstr))\n                        {\n                            if (*((char **)v2->ref))\n                            {\n                                FREE(*((char **)v2->ref));\n                            }\n                            *((char **)v2->ref) = str_dup(sstr);\n                            FREE(sstr);\n                        }\n                        else\n                        {\n                            v2->val.ptr = nullptr;\n                        }\n                    }\n                    break;\n                case DILV_FAIL:\n                case DILV_NULL:\n                    v->type = DILV_FAIL;\n                    break;\n                default:\n                    v->type = DILV_ERR;\n                    break;\n            }\n            break;\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n    }\n\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n}",
    "dil_example": "dilbegin aware do_reply(arg:string);\nvar\n\terr:integer;\n\tmsg_old:stringlist;\n\tmsg:string;\n\tmsg_time:string;\n\tu:unitptr;\n\txn:extraptr;\n\ti:integer;\n\tln:integer;\n\tmsg_num:integer;\n\ttemp:string;\n\tact_str:string;\n\tbuff:string;\n\tindexlist:stringlist;\n\tbrdname:string;\n\ncode\n{\n   if (self.type!=UNIT_ST_PC)\n      quit;\n\n   u:=self.inside;\n   while (u != null)\n\t{\n      if (u.type!=UNIT_ST_OBJ)\n      {\n         u:=u.next;\n         continue;\n      }\n      if (u.objecttype==ITEM_BOARD)\n         break;\n      u:=u.next;\n\t}\n\n   if (u==null)\n\t{\n      u:=self.outside.inside;\n      while (u!=null)\n\t\t{\n         if (u.type!=UNIT_ST_OBJ)\n         {\n            u:=u.next;\n            continue;\n         }\n      \tif (u.objecttype==ITEM_BOARD)\n\t\t   \tbreak;\n         u:=u.next;\n\t\t}\n   }\n\n   if (u.objecttype!=ITEM_BOARD)\n\t{\n      act (\"You have nothing to write on.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      quit;\n   }\n\n\tif (u.extra.[\"$BOARD_P_RES\"].descr!=\"\")\n   {\n      act_str := (string) u.extra.[\"$BOARD_P_RES\"].descr(self,u);\n      if (act_str!=\"\")\n      {\n         act(act_str, A_ALWAYS, self, null, null, TO_CHAR);\n         quit;\n      }\n   }\n   else\n   {\n\t\tif (self.level<10)\n      {\n      \tact(\"You need to be level 10 to post to this board.\", A_ALWAYS,self,null,null,TO_CHAR);\n   \t\tquit;\n      }\n   }\n\n   if (arg == \"\")\n\t{\n   \tact(\"Reply to which post?\", A_ALWAYS,self,null,null,TO_CHAR);\n\t\tquit;\n   }\n\n   msg_num:=atoi(arg);\n   xn:=\"$BOARD_MAX\" in u.extra;\n   if ((msg_num<=0) or (msg_num>atoi(xn.descr)))\n   {\n\t   brdname := xn.descr;\n\t   if (brdname == null)\n\t   \tbrdname := \"999\";\n      act (\"You must Reply to a post between 1 - \"+brdname+\".\",\n      A_ALWAYS,self,null,null,TO_CHAR);\n      quit;\n   }\n\n   brdname:=u.names.[length(u.names)-1];\n   err:=loadstr (brdname+\".idx\",temp);\n   if (err<0)\n\t{\n      log (\"02:  Error in boards on:  \"+brdname);\n      act (\"This board doesn't work report to an administrator.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n\t}\n\n   if (err==0)\n\t{\n      act (\"But the board is empty.\", A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n   }\n\n   indexlist:=split(temp,\"<br/>\");\n   ln:=length(indexlist);\n   if (msg_num>ln)\n\t{\n      act (\"That message exists only within the boundaries of your mind.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n\t}\n\n   if (ln>=atoi (xn.descr))\n\t{\n      act (\"You can't reply to that the board is full.\",\n         A_ALWAYS,self,null,null,TO_CHAR);\n      goto quitboard;\n\t}\n\n   msg_time:=indexlist.[msg_num-1];\n   msg_time:=getword( msg_time);\n   /*msg_old:=split(msg_time,\".\");*/\n\n\terr:=loadstr(brdname+\".\"+msg_time,buff);\n\tif (err==0)\n   {\n      sendtext (\"You can only reply to finished posts please wait and try again.<br/>\",self);\n      quit;\n   }\n   msg:=indexlist.[msg_num-1];\n   buff:=getword(msg);\n   msg_old:=split(msg,\" (\");\n   ln:=length(msg_old);\n   if (ln >2)\n\t{\n      i:=0;\n      while (i<ln-1)\n      {\n         if (i==0)\n            msg:=msg_old.[i];\n         else\n            msg:=msg+\" (\"+msg_old.[i];\n         i:=i+1;\n      }\n   }\n   else\n\t   msg:=msg_old.[0];\n\n   msg_time:=itoa(realtime);\n   msg:=msg_time+ \".re \"+msg+\" (\"+self.name+\")\";\n   msg:=\"<br/>\"+msg;\n   err:=savestr(brdname+\".idx\",msg,\"a\");\n   if (err<1)\n\t{\n\tlog (\"03:  Error in boards on:  \"+brdname);\n\tact (\"This board doesn't work report to an administrator.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\tgoto quitboard;\n\t}\ntemp:=indexlist.[msg_num-1];\nmsg:=getword(temp);\nact (\"You begin to reply to '\"+temp+\"'\",\nA_ALWAYS,self,null,null,TO_CHAR);\nact (\"$1n begins to write a message on the board.\",\nA_ALWAYS,self,null,null,TO_REST);\n\ninterrupt (SFB_MSG,((activator==self) and (argument==\"linkdead\")),clean_up);\n\tinterrupt(SFB_DEAD, activator == self, clean_up);\ninterrupt (SFB_COM,activator==self,clean_up);\ninterrupt (SFB_DONE, ((command(\"eat\")) and\n(medium==self)),clean_up);\n\n\tbeginedit (self);\n\twait(SFB_EDIT,self==activator) ;\nif (argument!=\"\")\n\t{\ntemp:=argument;\n\terr:=savestr(brdname+\".\"+msg_time+\".re\",temp,\"w\");\n\tif (err<1)\n\t\t{\n\t\tlog (\"04:  Error in boards on:  \"+brdname);\n\t\tact (\"This board doesn't work report to an administrator.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\tgoto quitboard;\n\t}\nact (\"Message:  \"+itoa(length(indexlist)+1)+\" posted.\",\n\tA_ALWAYS,self,null,null,TO_CHAR);\n\t}\nelse\n\t{\n:clean_up:\n\n\terr:=loadstr(brdname+\".idx\",buff);\n\tif (err<1)\n\t\tgoto quitboard;\n\tindexlist:=split(buff,\"<br/>\");\n\tmsg_num:=length(indexlist);\n\tmsg_num:=msg_num-1;\n\ntemp:=indexlist.[msg_num];\ntemp:=getword(temp);\nerr:=delstr (brdname+\".idx\");\nerr:=delstr (brdname+\".\"+temp);\nln:=length(indexlist);\ni:=0;\nbuff:=\"\";\nwhile (i<ln)\n\t{\n\tif (msg_num==i)\n\t\t{\n\t\ti:=i+1;\n\t\tcontinue;\n\t\t}\n\tif (length(buff)==0)\n\t\tbuff:=indexlist.[i];\n\telse\n\t\tbuff:=buff+\"<br/>\"+indexlist.[i];\n\ti:=i+1;\n\t}\n\n      err:=savestr(brdname+\".idx\",buff,\"w\");\n      if (err<1)\n      {\n         log (\"07:  Error in writing new idx file. in remove for \"+self.symname);\n         goto quitboard;\n      }\n      act (\"Blank posts are such a waste of space!  Removing.\", A_ALWAYS, self,null,null,TO_CHAR);\n   }\n\n   act(\"$1n finishes posting to the board.\", A_ALWAYS,self,null,null,TO_REST);\n\n   :quitboard:\n   send_done(\"reply\",self,null,u,0,arg,null, CMD_AUTO_NONE);\n   killedit(self);\n   quit;\n} dilend"
}