{
    "keyword": "replace",
    "opcode": "DILSE_REPLACE",
    "yacc_rule": "| DILSE_REPLACE '(' dilexp ',' dilexp ',' dilexp ')'\n{\n    INITEXP($$);\n\n    if ($3.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 1 of 'replace' not a string.\");\n    }\n    if ($5.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 2 of 'replace' not a string.\");\n    }\n    if ($7.typ != DilVarType_e::DILV_SP)\n    {\n        dilfatal(\"Arg 3 of 'replace' not a string.\");\n    }\n    else\n    {\n        /* Type is ok */\n        /* Make nodes dynamic */\n        $$.dsl = DSL_DYN;\n        $$.typ = DilVarType_e::DILV_SP;\n        make_code(&($3));\n        make_code(&($5));\n        make_code(&($7));\n        add_code(&($$), &($3));\n        add_code(&($$), &($5));\n        add_code(&($$), &($7));\n        add_ubit8(&($$), DILE_REPLACE);\n    }\n    FREEEXP($3);\n    FREEEXP($5);\n    FREEEXP($7);\n}",
    "dilfe_name": "dilfe_replace",
    "c_implementation": "void dilfe_replace(dilprg *p)\n{\n    dilval *v = new dilval;\n    // char *buf;\n    // int olen, nlen, buflen, i;\n    dilval *v3 = p->stack.pop();\n    dilval *v2 = p->stack.pop();\n    dilval *v1 = p->stack.pop();\n\n    v->type = DILV_SP;\n\n    switch (dil_getval(v1))\n    {\n        case DILV_FAIL:\n        case DILV_NULL:\n            v->type = DILV_FAIL;\n            break;\n        default:\n            v->type = DILV_ERR;\n            break;\n        case DILV_SP:\n            switch (dil_getval(v2))\n            {\n                case DILV_FAIL:\n                case DILV_NULL:\n                    v->type = DILV_FAIL;\n                    break;\n                default:\n                    v->type = DILV_ERR;\n                    break;\n                case DILV_SP:\n\n                    switch (dil_getval(v3))\n                    {\n                        case DILV_FAIL:\n                        case DILV_NULL:\n                            v->type = DILV_FAIL;\n                            break;\n                        default:\n                            v->type = DILV_ERR;\n                            break;\n                        case DILV_SP:\n                            if (v->type == DILV_SP)\n                            {\n                                std::string sch((char *)v1->val.ptr);\n                                std::string rpl((char *)v2->val.ptr);\n                                std::string mystr((char *)v3->val.ptr);\n\n                                str_substitute(sch, rpl, mystr);\n\n                                v->atyp = DILA_EXP;\n                                v->val.ptr = str_dup(mystr.c_str());\n                                /*\n                                MS2020 This could crash if replacing multiple instances of string (buffer OOB)\n                                olen = strlen((char *)v1->val.ptr);\n                                nlen = strlen((char *)v2->val.ptr);\n                                buflen = strlen((char *)v3->val.ptr);\n\n                                i = (nlen - olen);\n                                if (i < 0)\n                                    buflen = buflen + olen + 10;\n                                else\n                                    buflen =\n                                        buflen + (((nlen - olen) / (olen)) * olen) + olen + 20;\n                                CREATE(buf, char, buflen);\n                                strcpy(buf, (char *)v3->val.ptr);\n                                str_substitute((char *)v1->val.ptr, (char *)v2->val.ptr, buf);\n\n                                FREE(buf);*/\n                            }\n                            else\n                            {\n                                v->type = DILV_FAIL;\n                            }\n\n                            break;\n                    }\n\n                    break;\n            }\n\n            break;\n    }\n    p->stack.push(v);\n    delete v1;\n    delete v2;\n    delete v3;\n}",
    "dil_example": "dilbegin aware  piset(arg:string);\nexternal\n stringlist make_names(s:string);\nvar\n i:integer;\n  ln:integer;\n  temp:string;\n  tmp:string;\n  u:unitptr;\n  j:integer;\njln:integer;\n  action:string;\n  slist:stringlist;\ncode\n{\n\nif (arg==\"\")\n {\n sendtext (\"piset what?<br/>\",self);\n quit;\n }\n\nu:=findunit(self,arg,FIND_UNIT_INVEN,null);\nif (u==null)\n {\n sendtext(\"No such object found.<br/>\",self);\n quit;\n }\n\nif (u.type!=UNIT_ST_OBJ)\n {\n sendtext(\"No such object found.<br/>\",self);\n quit;\n }\n\nif (u.zoneidx!=\"treasure\")\n {\n sendtext(u.title+\" is not a Power Item.<br/>\",self);\n quit;\n }\n\nif (\"$no_rename\" in u.extra)\n{\nsendtext(u.title+\" is a unique item that can not be renamed.<br/>\",self);\nquit;\n}\n\nsecure(u,lostu);\naction:=getword (arg);\nif (action==left(\"title\",length(action)))\n goto do_title;\nelse if (action==left(\"shortdescr\",length(action)))\n goto do_shortdescr;\nelse if (action==left(\"descr\",length(action)))\n goto do_descr;\nelse\n {\n sendtext (\"Incorrect argument to piset please see <help piset><br/>\",self);\n quit;\n }\n:arg_title:\narg:=argument;\ngoto do_title;\n:arg_title2:\narg:=excmdstr+\" \"+argument;\n:do_title:\nif (u.extra.[\"$pititle\"].descr==\"true\")\n {\n sendtext (\"You have already set this objects title.<br/>\",self);\n quit;\n }\n\n\ntemp:=self.prompt;\nself.prompt:=\"Is \"+arg+\" the title you want? ([Q]uit, [Y]es, or (N)o\";\ni:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nwait (SFB_CMD,self==activator);\nself.prompt:=temp;\nif (excmdstr==left(\"quit\",length(excmdstr)))\n {\n block;\n sendtext (\"Command Canceled.<br/>\",self);\n i:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\n quit;\n }\nelse if (excmdstr==left(\"yes\",length(excmdstr)))\n {\n block;\n goto cont_title;\n }\n\nblock;\ntemp:=self.prompt;\nself.prompt:=\"Enter a new title:  \";\ni:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nwait (SFB_CMD,self==activator);\nblock;\nself.prompt:=temp;\ngoto arg_title2;\n\n:cont_title:\n\nslist:=make_names(arg);\nln:=length(slist);\ni:=0;\nwhile (i<ln)\n {\n if (slist.[i] in u.names)\n  {\n  i:=i+1;\n  continue;\n  }\n j:=0;\njln:=length(u.names);\nwhile (j<jln)\n{\n if (length(slist.[i])>length(u.names.[j]))\n break;\n  j:=j+1;\n}\n insert (u.names,j,slist.[i]);\n i:=i+1;\n }\nu.title:=arg;\naddextra (u.extra,{\"$pititle\"},\"true\");\nsendtext(\"Title set.<br/>\",self);\ni:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nquit;\n:arg_shortdescr:\narg:=argument;\ngoto do_shortdescr;\n:arg_shortdescr2:\narg:=excmdstr+\" \"+argument;\n:do_shortdescr:\nif (u.extra.[\"$pishortdescr\"].descr==\"true\")\n {\n sendtext (\"You have already set this objects short description.<br/>\",self);\n quit;\n }\n\n\ntemp:=self.prompt;\nself.prompt:=\"Is \"+arg+\" the short description you want? ([Q]uit, [Y]es, or (N)o\";\ni:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nwait (SFB_CMD,self==activator);\nself.prompt:=temp;\nif (excmdstr==left(\"quit\",length(excmdstr)))\n {\n block;\n sendtext (\"Command Canceled.<br/>\",self);\n i:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\n quit;\n }\nelse if (excmdstr==left(\"yes\",length(excmdstr)))\n {\n block;\n goto cont_shortdescr;\n }\n\nblock;\ntemp:=self.prompt;\nself.prompt:=\"Enter a new short description:  \";\ni:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nwait (SFB_CMD,self==activator);\nblock;\nself.prompt:=temp;\ngoto arg_shortdescr2;\n\n\n:cont_shortdescr:\n\nslist:=make_names(arg);\nln:=length(slist);\ni:=0;\nwhile (i<ln)\n {\n if (slist.[i] in u.names)\n  {\n  i:=i+1;\n  continue;\n  }\n j:=0;\njln:=length(u.names);\nwhile (j<jln)\n{\n if (length(slist.[i])>length(u.names.[j]))\n break;\n  j:=j+1;\n}\n\n insert (u.names,j,slist.[i]);\n i:=i+1;\n }\nu.outside_descr:=arg;\naddextra (u.extra,{\"$pishortdescr\"},\"true\");\nsendtext(\"Short description set.<br/>\",self);\nself.prompt:=temp;\ni:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nquit;\n\n:do_descr:\nif (u.extra.[\"$pidescr\"].descr==\"true\")\n {\n sendtext (\"You have already set this objects description.<br/>\",self);\n i:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\n quit;\n }\n\nsendtext (\"Enter item descr.  type '@' to end descr<br/>\",self);\n   beginedit(self);\n   wait(SFB_EDIT, self == activator);\n   temp := argument;\n   if (length(getwords(temp)) < 1)\n   {\n      sendtext(\"Insufficient description.  Exiting.<br/>\", self);\n      i:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\n      quit;\n   }\n/*temp:=replace (\"&h\",\"\",temp);*/\ntemp:=textformat(temp);\ntmp:=self.prompt;\nsendtext (textformat(temp),self);\n      i:=dildestroy(\"send_prompt@update\",self);\nself.prompt:=\"Is this the description you want? ([Q]uit, [Y]es, or (N)o \";\ndilcopy (\"send_prompt@update\",self);\n\nwait (SFB_CMD,self==activator);\nself.prompt:=tmp;\nif (excmdstr==left(\"quit\",length(excmdstr)))\n {\nblock;\n sendtext (\"Command Canceled.<br/>\",self);\n i:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\n quit;\n }\nelse if (excmdstr==left(\"yes\",length(excmdstr)))\n{\nblock;\n goto cont_descr;\n }\n\nblock;\ntmp:=self.prompt;\nsendtext(\"Enter a new description:  <br/>\",self);\ngoto do_descr;\n\n:cont_descr:\naddextra (u.extra,null,textformat (temp));\naddextra (u.extra,{\"$pidescr\"},\"true\");\n sendtext(\"Description set.<br/>\",self);\n i:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nquit;\n\n:lostu:\ni:=dildestroy(\"send_prompt@update\",self);\ndilcopy (\"send_prompt@update\",self);\n\nquit;\n} dilend"
}