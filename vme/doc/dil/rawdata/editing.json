{
    "keyword": "editing",
    "opcode": "DILSF_EDT",
    "yacc_rule": "| DILSF_EDT /* .editing */\n{\n    INITEXP($$);\n    $$.rtyp = DilVarType_e::DILV_UP;\n    $$.typ = DilVarType_e::DILV_INT;\n    $$.dsl = DSL_DYN;\n    $$.num = DILF_EDT;\n}",
    "dilfe_name": "DILF_EDT",
    "c_implementation": "case DILF_EDT:\n            switch (dil_getval(v1))\n            {\n                case DILV_NULL: /* not applicable */\n                case DILV_FAIL:\n                    v->type = DILV_FAIL; /* not applicable */\n                    break;\n                case DILV_UP:\n                    if (v1->val.ptr)\n                    {\n                        int editing = FALSE;\n                        unit_data *vict = nullptr;\n                        vict = ((unit_data *)v1->val.ptr);\n                        if (vict->isPC() && CHAR_DESCRIPTOR(vict) == nullptr)\n                        {\n                            descriptor_data *d = nullptr;\n                            for (d = g_descriptor_list; d; d = d->getNext())\n                            {\n                                if (descriptor_is_playing(d) && d->cgetOriginalCharacter() == vict)\n                                {\n                                    if (d->cgetEditing())\n                                    {\n                                        editing = TRUE;\n                                    }\n                                    break;\n                                }\n                            }\n                        }\n                        else\n                        {\n                            if (vict->isPC() && CHAR_DESCRIPTOR(vict))\n                            {\n                                if (CHAR_DESCRIPTOR(vict)->cgetEditing())\n                                {\n                                    editing = TRUE;\n                                }\n                            }\n                        }\n                        v->atyp = DILA_NONE;\n                        v->type = DILV_INT;\n                        v->val.num = editing;\n                    }\n                    else\n                    {\n                        v->type = DILV_FAIL; /* not applicable */\n                    }\n                    break;\n                default:\n                    v->type = DILV_ERR; /* wrong type */\n                    break;\n            }\n            break;",
    "dil_example": "dilbegin aware do_write (arg:string);\nvar\n\tln:integer;\n\tmsg_time:integer;\n\terr:integer;\n\tmsg:string;\n\ttemplist:stringlist;\n\ti:integer;\n\tmsg_num:integer;\n\tx:extraptr;\n\txm:extraptr;\n\tu:unitptr;\n\tact_str:string;\n\ttemp:string;\n\tbuff:string;\n\tbrdname:string;\n\tmaxnum:integer;\n\ncode\n{\n\nif (self.type!=UNIT_ST_PC)\nquit;\ntemp:=arg;\n\tu:=findunit (self,temp,FIND_UNIT_SURRO|FIND_UNIT_INVEN,null);\n\ttemp:=\"\";\n\n\tif ((u.type==UNIT_ST_PC) or\n\t(u.type==UNIT_ST_NPC))\n\tu:=null;\n\n\nif (u==null)\n\t{\n\tu:=self.inside;\n\twhile (u!=null)\n\t\t{\n\t\tif (u.type!=UNIT_ST_OBJ)\n\t\t\t{\n\t\t\tu:=u.next;\n\t\t\tcontinue;\n\t\t\t}\n\t\tif (u.objecttype==ITEM_BOARD)\n\t\t\tbreak;\n\t\tu:=u.next;\n\t\t}\n\t\t}\n\n\tif (u==null)\n\t\t{\n\t\tu:=self.outside.inside;\n\t\twhile (u!=null)\n\t\t\t{\n\t\t\tif (u.type!=UNIT_ST_OBJ)\n\t\t\t\t{\n\t\t\t\tu:=u.next;\n\t\t\t\tcontinue;\n\t\t\t\t}\n\t\tif (u.objecttype==ITEM_BOARD)\n\t\t\t\tbreak;\n\t\t\tu:=u.next;\n\t\t\t}\n\t\t}\n\n\tif (u==null)\n\t\t{\n\t\tif (self.outside.nameidx!=\"postoffice\")\n\t\t\t{\n\t\t\t:no_paper:\n\t\t\tact (\"You have nothing to write on.\",\n\t\t\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\t\tquit;\n\t\t\t}\n\t\telse\n\t\t\t{\n\t\t\tu:=load (\"letter@basis\");\n\t\t\tif (u==null)\n\t\t\t\tgoto no_paper;\n\t\t\tact (\"You have nothing to write on, so you grab a piece of paper from the Post Office.\",\n\t\t\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\t\tgoto item_note;\n\t\t\t}\n\t\t}\n\telse if (u.objecttype!=ITEM_NOTE)\n             goto item_board;\n\n\n:item_note:\n\nif (u.type!=UNIT_ST_OBJ)\n\tgoto no_paper;\n\n\nif (u.objecttype!=ITEM_NOTE)\n\tgoto no_paper;\n\n\nif (u.extra==null)\n\t{\n\tact (\"You begin to jot down a note on $2n\",\n\t\tA_ALWAYS,self,u,null,TO_CHAR);\nact (\"$1n begins to jot down a note.\",\nA_ALWAYS,self,null,null,TO_REST);\n\n\t\tsecure (u,lostpaper);\n\t\tinterrupt (SFB_MSG,((activator==self) and (argument==\"linkdead\")),lostpaper);\n\t\t         \tinterrupt(SFB_DEAD, activator == self, lostpaper);\ninterrupt (SFB_COM,activator==self,lostpaper);\ninterrupt (SFB_DONE, ((command(\"eat\")) and\n(medium==self)),lostpaper);\n\n\tbeginedit (self);\n\twait(SFB_EDIT,self==activator);\ntemp:=argument;\n\taddextra (u.extra,null,temp);\n\tact (\"Done editing\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tunsecure(u);\n\t\t:lostpaper:\n\t\tunsecure (u);\n\tquit;\n\t}\nelse\n\t{\n\tact (\"The $3n already has something written on it.\",\n\t\tA_ALWAYS,self,null,u,TO_CHAR);\n\tquit;\n\t}\n\n\n:item_board:\n\nif (u.objecttype!=ITEM_BOARD)\n\tgoto no_paper;\n\nif (dilfind(\"board@competition\",u))\n{\nsendtext(\"Only Administrators can write to competition boards silly.<br/>\",self);\nquit;\n}\n\nif (u.extra.[\"$BOARD_P_RES\"].descr!=\"\")\n\t\t{\n\t\tact_str:=(string)u.extra.[\"$BOARD_P_RES\"].descr(self,u);\n\t\tif (act_str!=\"\")\n\t\t{\n\tact(act_str,\n\t\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tquit;\n\t\t}\n\t\t}\nelse\n{\n\t\tif (self.level<10)\n\t\t\t\t{\n\tact(\"You need to be level 10 to post to this board.\",\n\t\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tquit;\n\t\t}\n\t\t}\n\n\nif (arg==\"\")\n\t{\n\tact(\"You must write a headline first.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tquit;\n\t\t}\nif (length (arg)>50)\n\t{\n\tact (\"Headline to long truncating.\",\n\tA_ALWAYS,self,null,null,TO_CHAR);\n\targ:=left(arg,50);\n\t}\n\nmsg_time:=realtime;\nmsg:=itoa(msg_time)+\" \"+arg+\" (\"+self.name+\")\";\nbrdname:=u.names.[length(u.names)-1];\nxm:=\"$BOARD_MAX\" in u.extra;\nmaxnum:=atoi(xm.descr);\n\nerr:=loadstr (brdname+\".idx\",temp);\nif (err==0)\n\t{\n\terr:=savestr(brdname+\".idx\",msg,\"w\");\n\tif (err<1)\n\t\t{\n\t\t:lostboard:\n\t\tlog (\"01:  Error in boards on:  \"+brdname);\n\t\tact (\"This board doesn't work report to an administrator.\",\n\t\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tgoto quitboard;\n\t\t}\n\t\tmsg_num:=1;\n\tgoto new_msg;\n\t}\nif (err<0)\n\t{\n\tlog (\"02:  Error in boards on:  \"+brdname);\n\tact (\"This board doesn't work report to an administrator.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tgoto quitboard;\n\t}\n\ntemplist:=split(temp,\"<br/>\");\nmsg_num:=length(templist)+1;\nif (msg_num>maxnum)\n\t{\n\tact (\"The board is full.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tgoto quitboard;\n\t}\n\ntemp:=\"<br/>\"+msg;\nerr:=savestr(brdname+\".idx\",temp,\"a\");\nif (err<1)\n\t{\n\tlog (\"03:  Error in boards on:  \"+brdname);\n\tact (\"This board doesn't work report to an administrator.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\t\tgoto quitboard;\n\t}\n\n:new_msg:\n\ninterrupt (SFB_MSG,((activator==self) and (argument==\"linkdead\")),clean_up);\n\tinterrupt(SFB_DEAD, activator == self, clean_up);\ninterrupt (SFB_COM,activator==self,clean_up);\ninterrupt (SFB_DONE, ((command(\"eat\")) and\n(medium==self)),clean_up);\n\nact (\"You begin to write a message on the board\",\nA_ALWAYS,self,null,null,TO_CHAR);\nact (\"$1n begins to write a message on the board.\",\nA_ALWAYS,self,null,null,TO_REST);\n\tbeginedit (self);\n\twait(SFB_EDIT,self==activator) ;\nif (argument!=\"\")\n\t{\ntemp:=argument;\n\terr:=savestr(brdname+\".\"+itoa(msg_time),temp,\"w\");\n\tif (err<1)\n\t\t{\n\t\tlog (\"04:  Error in boards on:  \"+brdname);\n\t\tact (\"This board doesn't work report to an administrator.\",\n\t\tA_ALWAYS,self,null,null,TO_CHAR);\n\tgoto quitboard;\n\t}\nact (\"Message:  \"+itoa(msg_num)+\" posted.\",\n\tA_ALWAYS,self,null,null,TO_CHAR);\n\t}\nelse\n\t{\n\t:clean_up:\n\n\n\n\n\terr:=loadstr(brdname+\".idx\",buff);\n\tif (err<1)\n\t\tgoto quitboard;\n\ttemplist:=split(buff,\"<br/>\");\n\ntemp:=templist.[msg_num-1];\ntemp:=getword(temp);\nerr:=delstr (brdname+\".idx\");\nerr:=delstr (brdname+\".\"+temp);\nln:=length(templist);\ni:=0;\nbuff:=\"\";\nwhile (i<ln)\n\t{\n\tif ((msg_num-1)==i)\n\t\t{\n\t\ti:=i+1;\n\t\tcontinue;\n\t\t}\n\tif (length(buff)==0)\n\t\tbuff:=templist.[i];\n\telse\n\t\tbuff:=buff+\"<br/>\"+templist.[i];\n\ti:=i+1;\n\t}\n\nerr:=savestr(brdname+\".idx\",buff,\"w\");\nif (err<1)\n{\n\tlog (\"07:  Error in writing new idx file. in remove for \"+brdname);\ngoto quitboard;\n}\n\tact (\"Blank posts are such a waste of space!  Removing.\",\n\t\tA_ALWAYS, self,null,null,TO_CHAR);\n}\n\tact (\"$1n finishes posting to the board.\",\n\tA_ALWAYS,self,null,null,TO_REST);\n\n:quitboard:\n send_done(\"write\",self,null,u,0,arg,null, CMD_AUTO_NONE);\nkilledit(self);\n\t\t quit;\n} dilend"
}