{
    "keyword": "weapons",
    "opcode": "DILSF_WPN",
    "yacc_rule": "| DILSF_WPN idx /* .weapons */\n{\n    INITEXP($$);\n    copy_code(&($$), &($2));\n    $$.rtyp = DilVarType_e::DILV_UP;\n    $$.typ = DilVarType_e::DILV_INT;\n    $$.dsl = DSL_LFT;\n    $$.num = DILF_WPN;\n    FREEEXP($2);\n}",
    "dilfe_name": "DILF_WPN",
    "c_implementation": "case DILF_WPN:\n            v2 = p->stack.pop(); /* evaluate index */\n            switch (dil_getval(v1))\n            {\n                case DILV_NULL: /* not applicable */\n                case DILV_FAIL:\n                    v->type = DILV_FAIL; /* not applicable */\n                    break;\n                case DILV_UP:\n                    v->type = DILV_INT;\n                    break;\n                default:\n                    v->type = DILV_ERR; /* wrong type */\n                    break;\n            }\n\n            switch (dil_getval(v2))\n            {\n                case DILV_FAIL:\n                    if (v->type != DILV_ERR)\n                    {\n                        v->type = DILV_FAIL; /* not applicable */\n                    }\n                    break;\n                case DILV_INT:\n                    break;\n\n                default:\n                    v->type = DILV_ERR; /* wrong type */\n                    break;\n            }\n\n            if (v->type == DILV_INT)\n            {\n                if (v1->val.ptr)\n                {\n                    switch (((unit_data *)v1->val.ptr)->getUnitType())\n                    {\n                        case UNIT_ST_NPC:\n                        {\n                            auto *npc = reinterpret_cast<npc_data *>(v1->val.ptr);\n                            if (is_in(v2->val.num, 0, WPN_GROUP_MAX - 1))\n                            {\n                                v->atyp = DILA_NONE;\n                                v->type = DILV_SINT2R;\n                                v->ref = npc->getWeaponSkillAtIndexPtr(v2->val.num);\n                            }\n                            else\n                            {\n                                v->type = DILV_FAIL;\n                            }\n                        }\n                        break;\n                        case UNIT_ST_PC:\n                            if (is_in(v2->val.num, 0, WPN_TREE_MAX - 1))\n                            {\n                                auto *pc = reinterpret_cast<pc_data *>(v1->val.ptr);\n                                if (p->frame[0].tmpl->zone->getAccessLevel() == 0)\n                                {\n                                    v->atyp = DILA_NONE;\n                                    v->type = DILV_SINT2R;\n                                    v->ref = pc->getWeaponSkillAtIndexPtr(v2->val.num);\n                                }\n                                else\n                                {\n                                    v->atyp = DILA_NONE;\n                                    v->type = DILV_INT;\n                                    v->val.num = pc->getWeaponSkillAtIndex(v2->val.num);\n                                }\n                            }\n                            else\n                            {\n                                v->type = DILV_FAIL;\n                            }\n                            break;\n\n                        default:\n                            v->type = DILV_ERR; /* illegal type */\n                            break;\n                    }\n                }\n                else\n                {\n                    v->type = DILV_FAIL; /* illegal type */\n                }\n            }\n            break;",
    "dil_example": "dilbegin clone_attr(original : unitptr, tgt : unitptr);\nvar\n   i : integer;\ncode\n{\n\n   /* - - - Abilities - - - */\n\n   i := 0;\n\n   while (i < ABIL_TREE_MAX)\n   {\n      tgt.abilities[i] := original.abilities[i];\n      i := i + 1;\n   }\n\n   /* tgt.level   := original.level; */\n   /* tgt.max_hp := original.max_hp; */\n   tgt.hp     := original.hp;\n\n   /* - - - Spells - - - */\n\n   i := 0;\n\n   if (tgt.type == UNIT_ST_PC)\n   {\n      while (i < SPL_GROUP_MAX)\n      {\n         tgt.spells[i] := (3 * original.spells[i]) / 2;\n         i := i + 1;\n      }\n   }\n   else\n   {\n      while (i < SPL_GROUP_MAX)\n      {\n         tgt.spells[i] := original.spells[i];\n         i := i + 1;\n      }\n   }\n\n\n\n   /* - - - Weapons - - - */\n\n   i := 0;\n\n   if (tgt.type == UNIT_ST_PC)\n   {\n      while (i < WPN_GROUP_MAX)\n      {\n         tgt.weapons[i] := (3 * original.weapons[i]) / 2;\n         i := i + 1;\n      }\n   }\n   else\n   {\n      while (i < SPL_GROUP_MAX)\n      {\n         tgt.weapons[i] := original.weapons[i];\n         i := i + 1;\n      }\n   }\n\n   quit;\n} dilend"
}